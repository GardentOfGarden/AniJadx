<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Смотреть аниме онлайн</title>
<meta name="description" content="Смотрите аниме онлайн в HD качестве. Большая коллекция аниме с русской озвучкой.">
<link rel="preconnect" href="https://shikimori.one">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
--bg-primary: #0A0B0D;
--bg-secondary: #12131A;
--bg-tertiary: #1A1B23;
--bg-interactive: #23242E;
--bg-interactive-hover: #2C2D38;
--text-primary: #FFFFFF;
--text-secondary: #8B8D98;
--text-tertiary: #5E6070;
--text-bright: #E0E0E0;
--accent-color: var(--text-primary);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

html {
scroll-behavior: smooth;
}

body {
background-color: var(--bg-primary);
color: var(--text-primary);
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
overflow-x: hidden;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
background-image: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.02) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255,255,255,0.01) 0%, transparent 50%);
background-attachment: fixed;
}

a {
text-decoration: none;
color: inherit;
}

ul {
list-style: none;
}

button, input, select {
font-family: inherit;
border: none;
outline: none;
background: none;
}

::selection {
background-color: var(--text-primary);
color: var(--bg-primary);
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { 
background: var(--bg-secondary); 
border-radius: 10px;
}
::-webkit-scrollbar-thumb { 
background: linear-gradient(180deg, var(--bg-interactive) 0%, var(--bg-interactive-hover) 100%);
border-radius: 10px;
border: 2px solid var(--bg-secondary);
}
::-webkit-scrollbar-thumb:hover { 
background: linear-gradient(180deg, var(--bg-interactive-hover) 0%, var(--text-primary) 100%);
}
::-webkit-scrollbar-corner { background: var(--bg-secondary); }

.loading-screen {
position: fixed; inset: 0; background: var(--bg-primary); display: flex;
align-items: center; justify-content: center; flex-direction: column;
gap: 24px; z-index: 9999; transition: opacity 0.3s ease, visibility 0.3s ease;
}
.loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

.loader {
--color-one: var(--text-primary);
--color-two: var(--text-secondary);
--color-three: rgba(255, 255, 255, 0.2);
--color-four: rgba(139, 141, 152, 0.2);
--color-five: rgba(255, 255, 255, 0.1);
--time-animation: 2s;
--size: 1;
position: relative;
border-radius: 50%;
transform: scale(var(--size));
box-shadow: 0 0 25px 0 var(--color-three), 0 20px 50px 0 var(--color-four);
}
.loader::before {
content: "";
position: absolute;
top: 0;
left: 0;
width: 100px;
height: 100px;
border-radius: 50%;
border-top: solid 1px var(--color-one);
border-bottom: solid 1px var(--color-two);
background: linear-gradient(180deg, var(--color-five), var(--color-four));
box-shadow: inset 0 10px 10px 0 var(--color-three), inset 0 -10px 10px 0 var(--color-four);
}
.loader .box {
width: 100px;
height: 100px;
background: linear-gradient(180deg, var(--color-one) 30%, var(--color-two) 70%);
mask: url(#clipping);
-webkit-mask: url(#clipping);
}
.loader svg { position: absolute; }
.loader svg #clipping {
filter: contrast(15);
animation: roundness calc(var(--time-animation) / 2) linear infinite;
}
.loader svg #clipping polygon { filter: blur(7px); }
.loader svg #clipping polygon:nth-child(1) {
transform-origin: 75% 25%;
transform: rotate(90deg);
}
.loader svg #clipping polygon:nth-child(2) {
transform-origin: 50% 50%;
animation: rotation var(--time-animation) linear infinite reverse;
}
.loader svg #clipping polygon:nth-child(3) {
transform-origin: 50% 60%;
animation: rotation var(--time-animation) linear infinite;
animation-delay: calc(var(--time-animation) / -3);
}
.loader svg #clipping polygon:nth-child(4) {
transform-origin: 40% 40%;
animation: rotation var(--time-animation) linear infinite reverse;
}
.loader svg #clipping polygon:nth-child(5) {
transform-origin: 40% 40%;
animation: rotation var(--time-animation) linear infinite reverse;
animation-delay: calc(var(--time-animation) / -2);
}
.loader svg #clipping polygon:nth-child(6) {
transform-origin: 60% 40%;
animation: rotation var(--time-animation) linear infinite;
}
.loader svg #clipping polygon:nth-child(7) {
transform-origin: 60% 40%;
animation: rotation var(--time-animation) linear infinite;
animation-delay: calc(var(--time-animation) / -1.5);
}
@keyframes rotation {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
@keyframes roundness {
0% { filter: contrast(15); }
20% { filter: contrast(3); }
40% { filter: contrast(3); }
60% { filter: contrast(15); }
100% { filter: contrast(15); }
}

.loading-text { color: var(--text-secondary); font-size: 14px; font-weight: 500; letter-spacing: 0.3px; }

.container, .catalog-container, .profile-container, .details-container {
max-width: 1400px; margin: 0 auto; padding: 0 40px;
}

.page { display: none; min-height: 100vh; }
.page.active { display: block; }
#home-page { padding-top: 0 !important; }

.header {
position: fixed; top: 0; left: 0; width: 100%; display: flex; align-items: center;
justify-content: space-between; padding: 15px 40px; z-index: 1000;
background: rgba(10, 11, 13, 0.9); backdrop-filter: blur(10px);
}
.header-nav ul { display: flex; align-items: center; gap: 8px; }
.header-nav a {
padding: 10px 18px; border-radius: 6px; font-size: 14px; font-weight: 600;
transition: all 0.2s ease; cursor: pointer; color: var(--text-secondary);
position: relative;
overflow: hidden;
letter-spacing: 0.3px;
}
.header-nav a::before {
content: '';
position: absolute;
inset: 0;
background: var(--bg-tertiary);
border-radius: 6px;
opacity: 0;
transition: opacity 0.2s ease;
z-index: -1;
}
.header-nav a:hover::before { opacity: 1; }
.header-nav a:hover { color: var(--text-primary); }
.header-nav a.active { 
background-color: var(--bg-interactive);
color: var(--text-primary);
}

.header-controls { display: flex; align-items: center; gap: 16px; }
.search-wrapper { position: relative; }
.search-wrapper input {
background: var(--bg-interactive); padding: 12px 16px 12px 40px; border-radius: 8px;
color: var(--text-primary); font-size: 14px; width: 250px; transition: all 0.2s ease;
border: 1px solid transparent;
font-weight: 500;
letter-spacing: 0.2px;
}
.search-wrapper input:focus {
background-color: var(--bg-interactive); 
border-color: var(--text-secondary);
box-shadow: 0 0 0 3px rgba(139, 141, 152, 0.1);
}
.search-wrapper svg {
position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
width: 18px; height: 18px; fill: var(--text-secondary); pointer-events: none;
}
.user-avatar-btn {
width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-interactive);
cursor: pointer; background-size: cover; background-position: center; transition: all 0.2s ease;
display: grid; place-items: center; font-weight: 700; font-size: 16px; color: var(--text-primary);
border: 1px solid var(--bg-tertiary);
position: relative;
overflow: hidden;
}
.user-avatar-btn:hover { 
background-color: var(--bg-interactive-hover);
border-color: var(--text-secondary);
}

.hero-section {
height: 600px; position: relative; display: flex; align-items: center; justify-content: center;
text-align: center; overflow: hidden;
}
.hero-bg {
position: absolute; inset: 0; background-size: cover; background-position: center;
z-index: -2; transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out; opacity: 0;
transform: scale(1.1);
filter: brightness(0.5);
}
.hero-bg.loaded { 
opacity: 1; 
transform: scale(1);
}
.hero-bg::after {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 200px;
background: linear-gradient(to bottom, transparent 0%, rgba(10, 11, 13, 0.8) 60%, var(--bg-primary) 100%);
backdrop-filter: blur(20px);
z-index: 1;
}

.hero-overlay {
position: absolute; inset: 0;
background: linear-gradient(to top, var(--bg-primary) 0%, rgba(10, 11, 13, 0.7) 40%, transparent 100%),
radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
z-index: -1;
}
.hero-content { 
max-width: 700px;
animation: heroContentFadeIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;
}
@keyframes heroContentFadeIn {
from {
opacity: 0;
transform: translateY(40px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
.hero-title { 
font-size: 56px; font-weight: 800; line-height: 1.1; margin-bottom: 20px; letter-spacing: -0.03em;
text-shadow: 0 4px 20px rgba(0,0,0,0.7);
}
.hero-meta {
display: flex; align-items: center; justify-content: center; gap: 16px;
font-size: 14px; color: var(--text-bright); margin-bottom: 20px; flex-wrap: wrap;
font-weight: 500;
letter-spacing: 0.3px;
}
.hero-meta span:not(:last-child)::after { content: '•'; margin-left: 16px; color: var(--text-tertiary); }
.hero-description {
font-size: 16px; line-height: 1.7; color: var(--text-bright); margin-bottom: 32px;
max-width: 600px; margin-left: auto; margin-right: auto;
display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
font-weight: 400;
letter-spacing: 0.2px;
}
.hero-actions { display: flex; align-items: center; justify-content: center; gap: 16px; }

.btn {
padding: 14px 32px; border-radius: 8px; font-size: 15px; font-weight: 600;
display: inline-flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; 
transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
border: 1px solid transparent;
position: relative;
overflow: hidden;
letter-spacing: 0.3px;
}
.btn::before {
content: '';
position: absolute;
inset: 0;
background: rgba(255, 255, 255, 0.1);
opacity: 0;
transition: opacity 0.3s ease;
z-index: -1;
}
.btn:hover::before { opacity: 1; }
.btn-primary { 
background: linear-gradient(135deg, var(--text-primary), rgba(255, 255, 255, 0.9));
color: var(--bg-primary);
border: 1px solid var(--text-primary);
}
.btn-primary:hover { 
transform: translateY(-2px);
box-shadow: 0 12px 24px rgba(255, 255, 255, 0.15);
}
.btn-primary:active { transform: translateY(0); }

.btn-secondary { 
background: var(--bg-interactive); 
color: var(--text-primary);
border: 1px solid var(--bg-interactive-hover);
}
.btn-secondary:hover { 
background: var(--bg-interactive-hover);
border-color: var(--text-secondary);
transform: translateY(-2px);
}
.btn-secondary:active { transform: translateY(0); }

.btn-outline {
background: transparent;
color: var(--text-primary);
border: 1px solid var(--text-secondary);
}
.btn-outline:hover {
border-color: var(--text-primary);
background: rgba(255, 255, 255, 0.05);
}

.btn svg { width: 18px; height: 18px; fill: currentColor; }

.page-loader { display: flex; justify-content: center; align-items: center; min-height: 50vh; }
.row { margin: 60px 0; }
.row-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
.row-title { font-size: 24px; font-weight: 700; letter-spacing: -0.02em; }
.row-link {
font-size: 14px; font-weight: 600; color: var(--text-secondary); display: flex;
align-items: center; gap: 6px; transition: all 0.2s ease;
letter-spacing: 0.2px;
}
.row-link:hover { color: var(--text-primary); }
.row-link svg { width: 16px; height: 16px; fill: currentColor; }

.card-list, .catalog-grid {
display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px;
}
.anime-card { 
display: block; 
transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
cursor: pointer;
}
.anime-card:hover { 
transform: translateY(-12px);
}
.anime-card-poster {
position: relative; margin-bottom: 12px; overflow: hidden;
border-radius: 12px; background: var(--bg-tertiary);
border: 1px solid var(--bg-tertiary);
aspect-ratio: 2/3;
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}
.anime-card-poster::after {
content: '';
position: absolute;
inset: 0;
background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.4) 100%);
z-index: 2;
pointer-events: none;
border-radius: 12px;
}
.anime-card-poster img {
width: 100%; height: 100%; 
object-fit: cover; border-radius: 12px; transition: transform 0.3s ease, filter 0.3s ease;
display: block;
}
.anime-card:hover .anime-card-poster img { 
transform: scale(1.08);
filter: brightness(1.1);
}
.anime-card-badge {
position: absolute; top: 8px; left: 8px; padding: 6px 12px;
background: rgba(255, 255, 255, 0.95); color: var(--bg-primary);
border-radius: 6px; font-size: 11px; font-weight: 700; z-index: 3;
backdrop-filter: blur(4px);
letter-spacing: 0.3px;
}
.anime-card-play {
position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
background: rgba(0, 0, 0, 0.5);
width: 56px; height: 56px; margin: auto;
opacity: 0; transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
z-index: 3;
transform: scale(0.7);
border-radius: 50%;
backdrop-filter: blur(4px);
border: 2px solid rgba(255, 255, 255, 0.2);
}
.anime-card:hover .anime-card-play { opacity: 1; transform: scale(1); }
.anime-card-play svg { width: 24px; height: 24px; fill: white; }
.anime-card-title {
font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden;
text-overflow: ellipsis; color: var(--text-secondary); transition: color 0.2s ease; margin-bottom: 4px;
letter-spacing: 0.2px;
}
.anime-card:hover .anime-card-title { color: var(--text-primary); }
.anime-card-info { font-size: 12px; color: var(--text-tertiary); font-weight: 500; letter-spacing: 0.2px; }
.anime-card-info-rating { display: flex; align-items: center; gap: 4px; }
.anime-card-info-rating svg { width: 14px; height: 14px; fill: var(--text-secondary); }

.catalog-header, .details-page-header, .profile-page-header {
margin-bottom: 40px;
}
.catalog-header h1, .details-page-header h1, .profile-page-header h1 {
font-size: 36px; font-weight: 800; margin-bottom: 12px; letter-spacing: -0.02em;
}
.catalog-header p, .details-page-header p, .profile-page-header p {
font-size: 16px; color: var(--text-secondary); max-width: 600px; letter-spacing: 0.2px;
}

.filters { 
display: flex; 
flex-wrap: wrap; 
gap: 16px; 
margin-bottom: 40px; 
}

.filter-select {
position: relative;
min-width: 200px;
}

.filter-select select {
width: 100%;
background: var(--bg-interactive);
border: 1px solid var(--bg-interactive-hover);
border-radius: 8px;
padding: 12px 40px 12px 16px;
color: var(--text-primary);
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
appearance: none;
letter-spacing: 0.2px;
}

.filter-select select:hover {
background: var(--bg-interactive-hover);
border-color: var(--text-secondary);
}

.filter-select select:focus {
background: var(--bg-interactive-hover);
border-color: var(--text-primary);
box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
}

.filter-select::after {
content: '';
position: absolute;
right: 16px;
top: 50%;
transform: translateY(-50%);
width: 0;
height: 0;
border-left: 5px solid transparent;
border-right: 5px solid transparent;
border-top: 6px solid var(--text-secondary);
pointer-events: none;
transition: all 0.2s ease;
}

.filter-select select:focus + ::after {
border-top-color: var(--text-primary);
}

.filter-select option {
background: var(--bg-tertiary);
color: var(--text-primary);
padding: 10px;
font-weight: 500;
}

.empty-state {
text-align: center; padding: 80px 20px; background: transparent; border-radius: 12px;
}
.empty-state h2 { font-size: 24px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.01em; }
.empty-state p { color: var(--text-secondary); margin-bottom: 24px; letter-spacing: 0.2px; }

#profile-page-grid {
display: grid;
grid-template-columns: 280px 1fr;
gap: 30px;
}
.profile-sidebar {
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
border-radius: 12px;
padding: 24px;
align-self: start;
text-align: center;
border: 1px solid rgba(255, 255, 255, 0.05);
backdrop-filter: blur(10px);
}
.profile-avatar {
width: 120px; height: 120px; border-radius: 50%; 
background: linear-gradient(135deg, var(--bg-interactive), var(--bg-interactive-hover));
margin: 0 auto 20px;
background-size: cover; display: grid; place-items: center;
font-size: 48px; font-weight: 700;
border: 3px solid rgba(255, 255, 255, 0.1);
}
.profile-sidebar h1 { font-size: 22px; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.01em; }
.profile-sidebar p { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; letter-spacing: 0.2px; }
.profile-stats { display: flex; justify-content: space-around; margin-bottom: 24px; }
.profile-stat { display: flex; flex-direction: column; align-items: center; }
.profile-stat-value { font-size: 24px; font-weight: 800; margin-bottom: 2px; letter-spacing: -0.01em; }
.profile-stat-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.2px; }
.profile-main-content {
display: flex;
flex-direction: column;
gap: 30px;
}
.profile-section { 
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
border-radius: 12px; 
padding: 24px;
border: 1px solid rgba(255, 255, 255, 0.05);
backdrop-filter: blur(10px);
}
.profile-section h2 { 
font-size: 20px; 
font-weight: 700; 
margin-bottom: 20px;
display: flex;
align-items: center;
justify-content: space-between;
letter-spacing: -0.01em;
}
.profile-section h2 a {
font-size: 14px;
color: var(--text-secondary);
font-weight: 600;
transition: color 0.2s ease;
letter-spacing: 0.2px;
}
.profile-section h2 a:hover { color: var(--text-primary); }
.profile-section .card-list { 
grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
gap: 16px;
}

.modal-overlay {
position: fixed; inset: 0; background: rgba(0, 0, 0, .9); backdrop-filter: blur(10px);
z-index: 2000; display: flex; align-items: center; justify-content: center;
opacity: 0; pointer-events: none; transition: opacity .3s ease;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal-content {
background: var(--bg-secondary); border-radius: 16px; padding: 2rem;
width: 100%; max-width: 400px; position: relative;
transform: scale(.9); transition: transform .3s ease; 
border: 1px solid rgba(255, 255, 255, 0.05);
backdrop-filter: blur(20px);
}
.modal-overlay.active .modal-content { transform: scale(1); }
.modal-close-btn {
position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px;
background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; color: var(--text-secondary);
display: flex; align-items: center; justify-content: center; transition: all .3s ease;
border: 1px solid transparent;
}
.modal-close-btn:hover { 
background: var(--bg-interactive-hover); 
color: var(--text-primary);
transform: rotate(90deg);
border-color: var(--text-secondary);
}

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: .4rem; font-weight: 500; font-size: .85rem; letter-spacing: 0.2px; }
.form-input {
width: 100%; background: var(--bg-tertiary); border: 1px solid var(--bg-interactive);
border-radius: 8px; padding: .7rem 1rem; color: var(--text-primary);
font-size: .9rem; transition: all .3s ease; font-weight: 500; letter-spacing: 0.2px;
}
.form-input:focus { 
border-color: var(--accent-color); 
background: var(--bg-primary);
box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
}
.submit-btn {
width: 100%; background: var(--accent-color); color: var(--bg-primary); border-radius: 8px;
padding: .8rem; font-size: .95rem; font-weight: 600; cursor: pointer; 
transition: all .3s ease;
border: 1px solid var(--accent-color);
letter-spacing: 0.3px;
}
.submit-btn:hover { 
background: rgba(255, 255, 255, 0.9);
transform: translateY(-2px);
box-shadow: 0 8px 16px rgba(255, 255, 255, 0.1);
}
.submit-btn:active { transform: translateY(0); }
.submit-btn:disabled { opacity: .5; cursor: not-allowed; }

.details-grid {
display: grid;
grid-template-columns: 280px 1fr;
gap: 40px;
}
.details-sidebar { align-self: start; }
.details-poster {
position: relative;
margin-bottom: 20px;
}
.details-poster img { 
width: 100%; 
border-radius: 12px; 
border: 1px solid var(--bg-tertiary);
display: block;
box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
}
.details-poster::after {
content: '';
position: absolute;
bottom: -12px;
left: 0;
right: 0;
height: 40px;
background: linear-gradient(180deg, var(--bg-primary) 0%, transparent 100%);
border-radius: 0 0 12px 12px;
filter: blur(8px);
z-index: -1;
}
.details-main-content h1 { font-size: 36px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.02em; }
.details-main-content h2 { font-size: 18px; color: var(--text-secondary); font-weight: 500; margin-bottom: 24px; letter-spacing: 0.2px; }
.details-meta {
display: grid; 
grid-template-columns: 1fr;
gap: 14px;
font-size: 14px;
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
padding: 20px;
border-radius: 8px;
border: 1px solid rgba(255, 255, 255, 0.05);
}
.details-meta-row { display: flex; justify-content: space-between; }
.details-meta-label { color: var(--text-secondary); font-weight: 500; letter-spacing: 0.2px; }
.details-meta-value { font-weight: 600; text-align: right; letter-spacing: 0.2px; }
.details-meta-value.genres { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
.details-meta-value.genres span { 
background: var(--bg-interactive); 
padding: 6px 12px; 
border-radius: 20px; 
font-size: 12px;
border: 1px solid rgba(255, 255, 255, 0.05);
transition: all 0.2s ease;
letter-spacing: 0.2px;
}
.details-meta-value.genres span:hover {
background: var(--bg-interactive-hover);
border-color: var(--text-secondary);
}
.details-actions { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 24px; }

.details-description {
line-height: 1.8;
color: var(--text-bright);
background: linear-gradient(135deg, rgba(18, 19, 26, 0.5), rgba(26, 27, 35, 0.3));
padding: 24px;
border-radius: 8px;
border: 1px solid rgba(255, 255, 255, 0.05);
letter-spacing: 0.2px;
}
.details-description p {
margin-bottom: 16px;
}

.tabs { display: flex; gap: 1.8rem; margin-bottom: 1.8rem; border-bottom: none; overflow-x: auto; scrollbar-width: none; }
.tabs::-webkit-scrollbar { display: none; }
.tab-item {
padding: .8rem 0; color: var(--text-secondary); font-size: .95rem; font-weight: 600;
cursor: pointer; position: relative; transition: color .3s ease; white-space: nowrap;
letter-spacing: 0.2px;
}
.tab-item.active, .tab-item:hover { color: var(--text-primary); }
.tab-item::after {
content: ''; position: absolute; bottom: -8px; left: 0; width: 0; height: 3px;
background: var(--text-primary); border-radius: 2px; transition: width .3s ease;
}
.tab-item.active::after { width: 100%; }
.tab-content { display: none; }
.tab-content.active { display: block; }

.player-container {
width: 100%;
aspect-ratio: 16/9;
background: #000;
border-radius: 12px;
overflow: hidden;
position: relative;
border: 1px solid var(--bg-tertiary);
margin-bottom: 20px;
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.player-container iframe {
width: 100%;
height: 100%;
border: none;
display: block;
}

.favorite-btn {
display: flex;
align-items: center;
gap: 8px;
padding: 12px 18px;
border-radius: 8px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
background: var(--bg-interactive);
color: var(--text-primary);
border: 1px solid var(--bg-interactive-hover);
transition: all 0.3s ease;
position: relative;
overflow: hidden;
letter-spacing: 0.3px;
}
.favorite-btn:hover {
background: var(--bg-interactive-hover);
border-color: var(--text-secondary);
transform: translateY(-2px);
}
.favorite-btn:active {
transform: translateY(0);
}
.favorite-btn.active {
background: rgba(255, 107, 107, 0.15);
border-color: rgba(255, 107, 107, 0.3);
color: #FF6B6B;
}
.favorite-btn svg { width: 18px; height: 18px; fill: currentColor; }

.toast {
position: fixed; bottom: 2rem; right: 2rem; background: var(--bg-secondary);
padding: 1rem 1.5rem; border-radius: 10px; 
box-shadow: 0 12px 28px -5px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,0.05);
z-index: 3000; opacity: 0; transform: translateY(20px) scale(0.9); 
transition: all .4s cubic-bezier(0.4, 0, 0.2, 1);
border: 1px solid var(--bg-tertiary); max-width: 300px;
backdrop-filter: blur(10px);
font-weight: 500;
letter-spacing: 0.2px;
}
.toast.show { 
opacity: 1; 
transform: translateY(0) scale(1); 
}
.toast.success { 
border-left: 4px solid #4caf50;
box-shadow: 0 12px 28px -5px rgba(76, 175, 80, 0.3), 0 0 0 1px rgba(76, 175, 80, 0.2);
}
.toast.error { 
border-left: 4px solid #f44336;
box-shadow: 0 12px 28px -5px rgba(244, 67, 54, 0.3), 0 0 0 1px rgba(244, 67, 54, 0.2);
}

#search-page .search-header {
text-align: center;
margin-bottom: 40px;
}
#search-page .search-header h1 {
font-size: 28px;
font-weight: 700;
letter-spacing: -0.01em;
}
#search-page .search-header h1 span {
color: var(--text-primary);
font-weight: 800;
}
#search-page .search-header p {
font-size: 16px;
color: var(--text-secondary);
margin-top: 8px;
letter-spacing: 0.2px;
}

.mobile-nav {
display: none;
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: rgba(18, 19, 26, 0.95);
backdrop-filter: blur(10px);
border-top: 1px solid rgba(255, 255, 255, 0.05);
padding: 8px 0;
z-index: 1000;
}
.mobile-nav-list {
display: flex;
justify-content: space-around;
align-items: center;
}
.mobile-nav-item {
display: flex;
flex-direction: column;
align-items: center;
gap: 4px;
padding: 8px 16px;
color: var(--text-secondary);
font-size: 11px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
letter-spacing: 0.3px;
}
.mobile-nav-item svg {
width: 22px;
height: 22px;
fill: currentColor;
}
.mobile-nav-item.active {
color: var(--text-primary);
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
.anime-card {
animation: fadeInUp 0.4s ease-out;
animation-fill-mode: both;
}
.anime-card:nth-child(1) { animation-delay: 0.05s; }
.anime-card:nth-child(2) { animation-delay: 0.1s; }
.anime-card:nth-child(3) { animation-delay: 0.15s; }
.anime-card:nth-child(4) { animation-delay: 0.2s; }
.anime-card:nth-child(5) { animation-delay: 0.25s; }
.anime-card:nth-child(6) { animation-delay: 0.3s; }
.anime-card:nth-child(7) { animation-delay: 0.35s; }
.anime-card:nth-child(8) { animation-delay: 0.4s; }

@keyframes shimmer {
0% { background-position: -1000px 0; }
100% { background-position: 1000px 0; }
}
.page-loader {
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
background-size: 1000px 100%;
animation: shimmer 2s infinite;
}

.page {
animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}
.mobile-nav-item.active svg {
animation: pulse 2s ease-in-out infinite;
}

@media (max-width: 1024px) {
.header-nav { display: none; }
.details-grid { grid-template-columns: 220px 1fr; }
}
@media (max-width: 768px) {
.container, .catalog-container, .profile-container, .details-container { padding: 0 20px; }
.header { padding: 15px 20px; }
.header-nav { display: none; }
.mobile-nav { display: block; }
body { padding-bottom: 70px; }
.search-wrapper input { width: 150px; }
.hero-title { font-size: 36px; }
.filters { flex-direction: column; }
.filter-select { width: 100%; }
.card-list, .catalog-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
.details-grid { grid-template-columns: 1fr; text-align: center; }
.details-sidebar { max-width: 260px; margin: 0 auto; }
.details-meta-row { justify-content: space-between; }
.details-meta-value { text-align: right; }
.details-actions { justify-content: center; }
#profile-page-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
<div class="loader">
<div class="box"></div>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
<defs>
<filter id="clipping">
<feGaussianBlur in="SourceGraphic" stdDeviation="0" result="blur" />
<feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 19 -9" result="goo" />
<feComposite in="SourceGraphic" in2="goo" operator="atop"/>
</filter>
</defs>
<clipPath id="clipping" clipPathUnits="objectBoundingBox">
<polygon points="0.35 0.15, 0.45 0.05, 0.55 0.15, 0.65 0.05, 0.75 0.15"></polygon>
<polygon points="0.15 0.35, 0.05 0.45, 0.15 0.55, 0.05 0.65, 0.15 0.75"></polygon>
<polygon points="0.35 0.85, 0.45 0.95, 0.55 0.85, 0.65 0.95, 0.75 0.85"></polygon>
<polygon points="0.85 0.35, 0.95 0.45, 0.85 0.55, 0.95 0.65, 0.85 0.75"></polygon>
<polygon points="0.5 0.5"></polygon>
<polygon points="0.5 0.5"></polygon>
<polygon points="0.5 0.5"></polygon>
</clipPath>
</svg>
</div>
<div class="loading-text">Загрузка...</div>
</div>

<header class="header" id="header">
<nav class="header-nav">
<ul>
<li><a data-nav="home">Главная</a></li>
<li><a data-nav="catalog">Каталог</a></li>
</ul>
</nav>
<div class="header-controls">
<div class="search-wrapper">
<svg viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
<input type="text" id="searchInput" placeholder="Поиск аниме...">
</div>
<button class="user-avatar-btn" id="profileBtn"></button>
</div>
</header>

<nav class="mobile-nav" id="mobileNav">
<ul class="mobile-nav-list">
<li class="mobile-nav-item" data-nav="home">
<svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg>
<span>Главная</span>
</li>
<li class="mobile-nav-item" data-nav="catalog">
<svg viewBox="0 0 24 24"><path d="M4,6H2V20A2,2 0 0,0 4,22H18V20H4V6M20,2H8A2,2 0 0,0 6,4V16A2,2 0 0,0 8,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H8V4H20V16M13,14L18,10.5L13,7V14Z"/></svg>
<span>Каталог</span>
</li>
<li class="mobile-nav-item" data-nav="favorites">
<svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/></svg>
<span>Избранное</span>
</li>
<li class="mobile-nav-item" data-nav="profile">
<svg viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
<span>Профиль</span>
</li>
</ul>
</nav>

<main id="home-page" class="page"></main>
<main id="catalog-page" class="catalog-container page"></main>
<main id="details-page" class="details-container page"></main>
<main id="profile-page" class="profile-container page"></main>
<main id="search-page" class="catalog-container page"></main>
<main id="favorites-page" class="catalog-container page"></main>
<main id="history-page" class="catalog-container page"></main>

<div id="modalOverlay" class="modal-overlay"></div>

<script>
const API_BASE = "https://shikimori.one";
const API_GRAPHQL = `${API_BASE}/api/graphql`;
const PLACEHOLDER_IMAGE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2' height='3' viewBox='0 0 2 3'%3E%3Crect width='2' height='3' fill='%231A1B23'/%3E%3C/svg%3E";

const DOM = {
pages: document.querySelectorAll('.page'),
header: document.getElementById("header"),
navLinks: document.querySelectorAll('.header-nav a'),
mobileNavItems: document.querySelectorAll('.mobile-nav-item'),
searchInput: document.getElementById("searchInput"),
profileBtn: document.getElementById("profileBtn"),
modalOverlay: document.getElementById("modalOverlay"),
loadingScreen: document.getElementById("loadingScreen"),
};

const app = {
state: {
currentView: "home",
heroItems: [], heroIndex: 0, heroInterval: null,
user: null,
favorites: new Set(['11757', '1', '16498']),
watchHistory: [],
shikiData: {},
cache: new Map(),
},

async init() {
this.updatePagePadding();
this.attachEventListeners();
this.loadUserData();
this.handleRoute();
window.addEventListener('load', () => setTimeout(() => DOM.loadingScreen.classList.add('hidden'), 300));
},

updatePagePadding() {
const headerHeight = DOM.header.offsetHeight;
DOM.pages.forEach(page => page.style.paddingTop = `${headerHeight + 40}px`);
},

attachEventListeners() {
window.addEventListener("popstate", () => this.handleRoute());
window.addEventListener("resize", this.debounce(() => this.updatePagePadding(), 100));
DOM.searchInput.addEventListener("input", this.debounce(() => this.handleSearch(), 400));
DOM.profileBtn.addEventListener('click', () => {
if (this.state.user && this.state.user.nickname) {
this.navigateTo('profile');
} else {
this.openAuthModal();
}
});

document.addEventListener("click", e => {
const navLink = e.target.closest('[data-nav]');
if (navLink) { e.preventDefault(); this.navigateTo(navLink.dataset.nav); }

const animeCard = e.target.closest('.anime-card[data-id]');
if (animeCard) { e.preventDefault(); this.navigateTo("details", animeCard.dataset.id); }

const favoriteBtn = e.target.closest('.favorite-btn');
if(favoriteBtn) { e.preventDefault(); e.stopPropagation(); this.toggleFavorite(favoriteBtn.dataset.animeId); }
});

DOM.modalOverlay.addEventListener("click", e => { if (e.target === DOM.modalOverlay) this.closeModal(); });
document.addEventListener("keydown", e => { if (e.key === "Escape" && DOM.modalOverlay.classList.contains("active")) this.closeModal(); });
window.addEventListener("beforeunload", () => this.saveUserData());
},

loadUserData() {
try {
const data = localStorage.getItem("animeUserData");
if (data) {
const parsed = JSON.parse(data);
if (parsed.user && parsed.user.nickname) {
this.state.user = parsed.user;
this.state.favorites = new Set(parsed.favorites || []);
this.state.watchHistory = parsed.watchHistory || [];
this.state.shikiData = parsed.shikiData || {};
} else {
this.state.user = null;
}
}
} catch (e) { console.warn("Failed to load user data", e); }
this.updateProfileButton();
},

saveUserData() {
try {
const data = {
user: this.state.user,
favorites: Array.from(this.state.favorites),
watchHistory: this.state.watchHistory,
shikiData: this.state.shikiData
};
localStorage.setItem("animeUserData", JSON.stringify(data));
} catch (e) { console.warn("Failed to save user data", e); }
},

updateProfileButton() {
if (this.state.user && this.state.user.nickname) {
DOM.profileBtn.textContent = this.state.user.nickname.charAt(0).toUpperCase();
} else {
DOM.profileBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>`;
}
},

addToWatchHistory(anime) {
if (!anime || !anime.id) return;
const existingIndex = this.state.watchHistory.findIndex(item => item.id === anime.id);
if (existingIndex > -1) this.state.watchHistory.splice(existingIndex, 1);
this.state.watchHistory.unshift(anime);
if (this.state.watchHistory.length > 50) this.state.watchHistory.pop();
this.saveUserData();
},

toggleFavorite(animeId) {
if (!animeId) return;
if (!this.state.user) { this.showToast("Необходимо авторизоваться", "error"); return; }
const idStr = String(animeId);
if (this.state.favorites.has(idStr)) {
this.state.favorites.delete(idStr);
this.showToast("Удалено из избранного");
} else {
this.state.favorites.add(idStr);
this.showToast("Добавлено в избранное");
}
this.saveUserData();
this.updateFavoriteButtons();
},

updateFavoriteButtons() {
document.querySelectorAll('.favorite-btn').forEach(btn => {
const animeId = String(btn.dataset.animeId);
const isFavorite = this.state.favorites.has(animeId);
btn.classList.toggle('active', isFavorite);
btn.innerHTML = `
<svg viewBox="0 0 24 24"><path d="${isFavorite ? 'M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z' : 'M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.36H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z'}"/></svg>
${isFavorite ? 'В избранном' : 'В избранное'}
`;
});
},

debounce: (func, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; },

showToast(message, type = "success") {
const toast = document.createElement("div");
toast.className = `toast ${type}`; toast.textContent = message;
document.body.appendChild(toast);
setTimeout(() => toast.classList.add("show"), 10);
setTimeout(() => { toast.classList.remove("show"); setTimeout(() => toast.remove(), 300); }, 3000);
},

handleRoute() {
const hash = window.location.hash.substring(1) || "home";
const [view, param] = hash.split("/");
this.navigateTo(view, param, false);
},

async navigateTo(view, param = '', updateHistory = true) {
if (this.state.heroInterval) { clearInterval(this.state.heroInterval); this.state.heroInterval = null; }
this.state.currentView = view;

if (updateHistory) {
const newHash = param ? `${view}/${param}` : view;
window.history.pushState({ view, param }, "", `#${newHash}`);
}

this.setActiveNav(view);
DOM.pages.forEach(p => p.classList.remove('active'));
const targetPage = document.getElementById(`${view}-page`) || document.getElementById('home-page');
targetPage.classList.add('active');
window.scrollTo({ top: 0, behavior: 'smooth' });

const viewHandlers = {
home: () => this.showHomePage(),
catalog: () => this.showCatalogPage(),
details: id => this.showDetailsPage(id),
profile: () => this.showProfilePage(),
search: query => this.showSearchPage(query),
favorites: () => this.showFavoritesPage(),
history: () => this.showHistoryPage()
};
await (viewHandlers[view] || viewHandlers.home)(param);
},

setActiveNav(view) {
DOM.navLinks.forEach(l => l.classList.toggle('active', l.dataset.nav === view));
DOM.mobileNavItems.forEach(l => l.classList.toggle('active', l.dataset.nav === view));
},

renderLoader: () => `<div class="page-loader"><div class="loading-spinner"></div></div>`,

async fetchAnimesGraphQL(filters = {}) {
const { limit = 30, order = 'popularity', genre = '', search = '' } = filters;

const query = `
query {
animes(
limit: ${limit}, 
order: ${order}
${genre ? `, genre: "${genre}"` : ''}
${search ? `, search: "${search}"` : ''}
) {
id
name
russian
score
kind
status
episodes
episodesAired
airedOn { year }
description
poster { 
originalUrl
main2xUrl
}
screenshots {
originalUrl
}
genres { 
id 
russian 
}
}
}
`;

const cacheKey = `graphql_${JSON.stringify(filters)}`;
if (this.state.cache.has(cacheKey)) {
return this.state.cache.get(cacheKey);
}

try {
const response = await fetch(API_GRAPHQL, {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'User-Agent': 'AnimeApp/2.0' },
body: JSON.stringify({ query })
});

if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

const result = await response.json();
const animes = result.data?.animes || [];

const formattedAnimes = animes.map(anime => ({
id: anime.id,
name: anime.name,
russian: anime.russian,
score: anime.score,
kind: anime.kind,
status: anime.status,
episodes: anime.episodes,
episodes_aired: anime.episodesAired,
aired_on: anime.airedOn?.year ? `${anime.airedOn.year}-01-01` : null,
description: anime.description,
posterUrl: anime.poster?.main2xUrl || anime.poster?.originalUrl,
bannerUrl: anime.screenshots?.[0]?.originalUrl || anime.poster?.originalUrl,
genres: anime.genres
}));

this.state.cache.set(cacheKey, formattedAnimes);
setTimeout(() => this.state.cache.delete(cacheKey), 300000);

return formattedAnimes;
} catch (error) {
console.error("GraphQL Error:", error);
this.showToast("Ошибка загрузки данных", "error");
return [];
}
},

async fetchAnimeByIdGraphQL(id) {
const query = `
query {
animes(ids: "${id}", limit: 1) {
id
name
russian
score
kind
status
episodes
episodesAired
airedOn { year }
description
descriptionHtml
poster { 
originalUrl
main2xUrl
}
genres { 
id 
russian 
}
}
}
`;

const cacheKey = `anime_${id}`;
if (this.state.cache.has(cacheKey)) {
return this.state.cache.get(cacheKey);
}

try {
const response = await fetch(API_GRAPHQL, {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'User-Agent': 'AnimeApp/2.0' },
body: JSON.stringify({ query })
});

if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

const result = await response.json();
const anime = result.data?.animes?.[0];

if (!anime) return null;

const formatted = {
id: anime.id,
name: anime.name,
russian: anime.russian,
score: anime.score,
kind: anime.kind,
status: anime.status,
episodes: anime.episodes,
episodes_aired: anime.episodesAired,
aired_on: anime.airedOn?.year ? `${anime.airedOn.year}-01-01` : null,
description: anime.description,
description_html: anime.descriptionHtml,
posterUrl: anime.poster?.main2xUrl || anime.poster?.originalUrl,
genres: anime.genres
};

this.state.cache.set(cacheKey, formatted);
setTimeout(() => this.state.cache.delete(cacheKey), 300000);

return formatted;
} catch (error) {
console.error("GraphQL Error:", error);
return null;
}
},

async fetchData(endpoint, options = {}) {
const cacheKey = endpoint + JSON.stringify(options);
if (this.state.cache.has(cacheKey)) {
return this.state.cache.get(cacheKey);
}
try {
const response = await fetch(`${API_BASE}/api${endpoint}`, {
...options,
headers: { 'User-Agent': 'AnimeApp/2.0', ...options.headers }
});
if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
if (response.status === 204) return true;
const data = await response.json();
this.state.cache.set(cacheKey, data);
setTimeout(() => this.state.cache.delete(cacheKey), 300000);
return data;
} catch (error) {
console.error("Fetch Error:", endpoint, error);
return null;
}
},

getPosterUrl(anime) {
if (!anime) return PLACEHOLDER_IMAGE;

if (anime.posterUrl) {
return anime.posterUrl.startsWith('http') ? anime.posterUrl : `${API_BASE}${anime.posterUrl}`;
}

const image = anime.image || {};
let imageUrl = image.original || image.preview || image.x96;

if (!imageUrl) return PLACEHOLDER_IMAGE;

return imageUrl.startsWith('http') ? imageUrl : `${API_BASE}${imageUrl}`;
},

getBannerUrl(anime) {
if (!anime) return PLACEHOLDER_IMAGE;

if (anime.bannerUrl) {
return anime.bannerUrl.startsWith('http') ? anime.bannerUrl : `${API_BASE}${anime.bannerUrl}`;
}

return this.getPosterUrl(anime);
},

escapeHtml: s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]),

renderAnimeCard(anime) {
if(!anime || !anime.russian) return '';

const posterUrl = this.getPosterUrl(anime);
const year = anime.aired_on ? new Date(anime.aired_on).getFullYear() : '';

return `
<a href="#details/${anime.id}" class="anime-card" data-id="${anime.id}">
<div class="anime-card-poster">
<img 
src="${posterUrl}" 
alt="${this.escapeHtml(anime.russian)}" 
loading="lazy"
onerror="this.src='${PLACEHOLDER_IMAGE}'"
>
<div class="anime-card-play"><svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg></div>
</div>
<h3 class="anime-card-title">${this.escapeHtml(anime.russian)}</h3>
<div class="anime-card-info">
${anime.score && anime.score > 0 ? `<span class="anime-card-info-rating"><svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/></svg> ${anime.score}</span>` : ''}
${anime.score && year ? ' • ' : ''}
${year}
</div>
</a>`;
},

renderAnimeGrid(list, container) {
if (!list || list.length === 0) {
container.innerHTML = '<div class="empty-state"><h2>Ничего не найдено</h2><p>Попробуйте изменить параметры поиска.</p></div>';
return;
}
container.innerHTML = list.map(anime => this.renderAnimeCard(anime)).join('');
},

async showHomePage() {
const page = document.getElementById('home-page');
page.innerHTML = this.renderLoader();

const releases = await this.fetchAnimesGraphQL({ limit: 30, order: 'popularity' });

if (!releases || releases.length === 0) {
page.innerHTML = '<div class="container"><p>Не удалось загрузить популярные релизы.</p></div>'; 
return;
}

this.state.heroItems = releases.slice(0, 5); 
this.state.heroIndex = 0;

page.innerHTML = `
<section class="hero-section">
<div id="heroBg" class="hero-bg"></div>
<div class="hero-overlay"></div>
<div class="hero-content container" id="heroContent"></div>
</section>
<div class="container" id="homeContent"></div>
`;

this.updateHero();
this.state.heroInterval = setInterval(() => this.changeHero(1), 7000);

document.getElementById('homeContent').innerHTML = `
<div class="row">
<div class="row-header">
<h2 class="row-title">Популярное сейчас</h2>
<a href="#catalog" data-nav="catalog" class="row-link">
Смотреть все 
<svg viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>
</a>
</div>
<div class="card-list">${releases.slice(5, 13).map(a => this.renderAnimeCard(a)).join('')}</div>
</div>
`;
},

updateHero() {
const hero = this.state.heroItems[this.state.heroIndex]; 
if (!hero) return;

const heroBg = document.getElementById('heroBg'); 
heroBg.classList.remove('loaded');

setTimeout(() => {
const bannerImage = this.getBannerUrl(hero);
heroBg.style.backgroundImage = `url(${bannerImage})`;
heroBg.classList.add('loaded');

const year = hero.aired_on ? new Date(hero.aired_on).getFullYear() : '';

document.getElementById('heroContent').innerHTML = `
<h1 class="hero-title">${this.escapeHtml(hero.russian)}</h1>
<div class="hero-meta">
${hero.kind ? `<span>${hero.kind}</span>` : ''}
${year ? `<span>${year}</span>` : ''}
${hero.episodes ? `<span>${hero.episodes} эп.</span>` : ''}
${hero.score ? `<span>★ ${hero.score}</span>` : ''}
</div>
<p class="hero-description">${this.escapeHtml(hero.description || 'Описание отсутствует')}</p>
<div class="hero-actions">
<a href="#details/${hero.id}" class="btn btn-primary">
<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg> 
Смотреть
</a>
</div>
`;
}, 50);
},

changeHero(dir) {
const len = this.state.heroItems.length; 
if(len === 0) return;
this.state.heroIndex = (this.state.heroIndex + dir + len) % len;
this.updateHero();
},

async showCatalogPage() {
const page = document.getElementById('catalog-page');
page.innerHTML = `
<div class="catalog-header">
<h1>Каталог аниме</h1>
<p>Откройте для себя тысячи аниме на любой вкус.</p>
</div>
<div class="filters" id="catalogFilters"></div>
<div class="catalog-grid" id="catalogGrid">${this.renderLoader()}</div>
`;
await this.setupFilters();
await this.loadCatalogContent();
},

async setupFilters() {
const container = document.getElementById('catalogFilters');
let genres = await this.fetchData("/genres");

if (genres) {
const seen = new Set();
genres = genres.filter(genre => {
const isAnime = genre.kind === 'anime';
const isDuplicate = seen.has(genre.name);
if(isAnime && !isDuplicate) {
seen.add(genre.name);
return true;
}
return false;
});
} else {
genres = [];
}

container.innerHTML = `
<div class="filter-select">
<select id="genreSelect">
<option value="">Все жанры</option>
${genres.map(g => `<option value="${g.id}">${this.escapeHtml(g.russian)}</option>`).join('')}
</select>
</div>
<div class="filter-select">
<select id="sortSelect">
<option value="popularity">По популярности</option>
<option value="ranked">По рейтингу</option>
<option value="name">По алфавиту</option>
</select>
</div>
`;

document.getElementById('genreSelect').addEventListener('change', () => this.loadCatalogContent());
document.getElementById('sortSelect').addEventListener('change', () => this.loadCatalogContent());
},

async loadCatalogContent() {
const grid = document.getElementById('catalogGrid'); 
grid.innerHTML = this.renderLoader();

const genre = document.getElementById('genreSelect')?.value || '';
const order = document.getElementById('sortSelect')?.value || 'popularity';

const data = await this.fetchAnimesGraphQL({ limit: 50, order, genre });
this.renderAnimeGrid(data, grid);
},

async showDetailsPage(id) {
const page = document.getElementById('details-page'); 
page.innerHTML = this.renderLoader();

const anime = await this.fetchAnimeByIdGraphQL(id);

if (!anime) { 
page.innerHTML = '<div class="empty-state"><h2>Аниме не найдено</h2></div>'; 
return; 
}

this.addToWatchHistory(anime);

const [franchiseData, similarData] = await Promise.all([
this.fetchData(`/animes/${id}/franchise`),
this.fetchData(`/animes/${id}/similar`)
]);

const franchiseReleases = franchiseData?.nodes
?.filter(n => n?.node?.id && n.node.russian)
.map(n => ({
...n.node,
posterUrl: n.node.image?.original ? `${API_BASE}${n.node.image.original}` : PLACEHOLDER_IMAGE
})) || [];

const similarReleases = similarData
?.filter(a => a?.id && a.russian)
.map(a => ({
...a,
posterUrl: a.image?.original ? `${API_BASE}${a.image.original}` : PLACEHOLDER_IMAGE
})) || [];

const posterUrl = this.getPosterUrl(anime);

page.innerHTML = `
<div class="details-grid">
<div class="details-sidebar">
<div class="details-poster">
<img src="${posterUrl}" alt="${this.escapeHtml(anime.russian)}" onerror="this.src='${PLACEHOLDER_IMAGE}'">
</div>
<div class="details-meta">
<div class="details-meta-row">
<span class="details-meta-label">Тип:</span><span class="details-meta-value">${anime.kind || 'н/д'}</span>
</div>
<div class="details-meta-row">
<span class="details-meta-label">Год:</span><span class="details-meta-value">${anime.aired_on ? new Date(anime.aired_on).getFullYear() : 'н/д'}</span>
</div>
<div class="details-meta-row">
<span class="details-meta-label">Статус:</span><span class="details-meta-value">${anime.status || 'н/д'}</span>
</div>
<div class="details-meta-row">
<span class="details-meta-label">Эпизоды:</span><span class="details-meta-value">${anime.episodes_aired || '?'}/${anime.episodes || '?'}</span>
</div>
${anime.score ? `
<div class="details-meta-row">
<span class="details-meta-label">Рейтинг:</span><span class="details-meta-value">⭐ ${anime.score}</span>
</div>
` : ''}
</div>
<div class="details-actions">
<button class="btn btn-secondary favorite-btn" data-anime-id="${anime.id}"></button>
</div>
</div>
<div class="details-main-content">
<h1>${this.escapeHtml(anime.russian)}</h1>
${anime.name ? `<h2>${this.escapeHtml(anime.name)}</h2>` : ''}

<div class="player-container">
<iframe 
src="https://kodik.info/find-player?shikimoriID=${id}" 
allowfullscreen
></iframe>
</div>

<div class="tabs">
<button class="tab-item active" data-tab="description-tab">Описание</button>
${similarReleases.length ? '<button class="tab-item" data-tab="similar-tab">Похожие</button>' : ''}
${franchiseReleases.length ? '<button class="tab-item" data-tab="franchise-tab">Франшиза</button>' : ''}
</div>
<div id="description-tab" class="tab-content active">
<div class="details-description">
${anime.description_html || '<p>Описание отсутствует.</p>'}
</div>
</div>
${similarReleases.length ? `
<div id="similar-tab" class="tab-content">
<div class="card-list"></div>
</div>
` : ''}
${franchiseReleases.length ? `
<div id="franchise-tab" class="tab-content">
<div class="card-list"></div>
</div>
` : ''}
</div>
</div>
`;

if (similarReleases.length) {
this.renderAnimeGrid(similarReleases, page.querySelector('#similar-tab .card-list'));
}
if (franchiseReleases.length) {
this.renderAnimeGrid(franchiseReleases, page.querySelector('#franchise-tab .card-list'));
}

document.querySelectorAll('.tab-item').forEach(tab => {
tab.addEventListener('click', () => {
document.querySelector('.tab-item.active')?.classList.remove('active'); 
tab.classList.add('active');
document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
document.getElementById(tab.dataset.tab)?.classList.add('active');
});
});

this.updateFavoriteButtons();
},

async showProfilePage() {
if (!this.state.user || !this.state.user.nickname) { 
this.openAuthModal(); 
return; 
}

if (!this.state.shikiData.id) {
const whoami = await this.fetchData('/users/whoami');
if(whoami) {
this.state.shikiData = {
id: whoami.id,
favorites: whoami.stats.full_statuses.anime.find(s => s.name === 'planned')?.size || 0,
watched: whoami.stats.full_statuses.anime.find(s => s.name === 'completed')?.size || 0
};
this.saveUserData();
}
}

const page = document.getElementById('profile-page');
const userInitial = this.state.user.nickname.charAt(0).toUpperCase();

page.innerHTML = `
<div id="profile-page-grid">
<div class="profile-sidebar">
<div class="profile-avatar">${userInitial}</div>
<h1>${this.escapeHtml(this.state.user.nickname)}</h1>
<p>${this.escapeHtml(this.state.user.email)}</p>
<div class="profile-stats">
<div class="profile-stat">
<div class="profile-stat-value">${this.state.shikiData.favorites || 0}</div>
<div class="profile-stat-label">В избранном</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value">${this.state.shikiData.watched || 0}</div>
<div class="profile-stat-label">Просмотрено</div>
</div>
</div>
<button class="btn btn-secondary" id="logoutBtn" style="width: 100%;">Выйти</button>
</div>
<div class="profile-main-content">
<div class="profile-section">
<h2>Избранное <a href="#favorites" data-nav="favorites">Смотреть все</a></h2>
<div class="card-list" id="profile-favorites">${this.state.favorites.size > 0 ? this.renderLoader() : '<p style="color: var(--text-secondary);">Список избранного пуст.</p>'}</div>
</div>
<div class="profile-section">
<h2>История просмотра <a href="#history" data-nav="history">Смотреть все</a></h2>
<div class="card-list" id="profile-history">${this.state.watchHistory.length > 0 ? '' : '<p style="color: var(--text-secondary);">История пуста.</p>'}</div>
</div>
</div>
</div>
`;

const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
logoutBtn.addEventListener('click', () => this.logout());
}

if (this.state.watchHistory.length > 0) {
this.renderAnimeGrid(this.state.watchHistory.slice(0, 4), document.getElementById('profile-history'));
}

if(this.state.favorites.size > 0) {
const favIds = Array.from(this.state.favorites).slice(0, 4);
const favs = await Promise.all(favIds.map(id => this.fetchAnimeByIdGraphQL(id)));
this.renderAnimeGrid(favs.filter(Boolean), document.getElementById('profile-favorites'));
}
},

async showSearchPage(query) {
const page = document.getElementById('search-page');
page.innerHTML = `
<div class="search-header">
<h1>Результаты по запросу: <span>"${this.escapeHtml(query)}"</span></h1>
</div>
<div class="catalog-grid" id="searchGrid">${this.renderLoader()}</div>
`;

const data = await this.fetchAnimesGraphQL({ search: query, limit: 50 });
this.renderAnimeGrid(data, document.getElementById('searchGrid'));
},

async showFavoritesPage() {
const page = document.getElementById('favorites-page');
page.innerHTML = `
<div class="catalog-header">
<h1>Избранное</h1>
<p>Ваши любимые аниме</p>
</div>
<div class="catalog-grid" id="favoritesGrid"></div>
`;

const grid = document.getElementById('favoritesGrid');

if (!this.state.user) { 
grid.innerHTML = '<div class="empty-state"><h2>Нужна авторизация</h2><p>Войдите в аккаунт, чтобы видеть избранное.</p></div>'; 
return; 
}

if (this.state.favorites.size === 0) { 
grid.innerHTML = '<div class="empty-state"><h2>Здесь пока пусто</h2><p>Добавляйте аниме в избранное.</p></div>'; 
return; 
}

grid.innerHTML = this.renderLoader();
const favoriteAnimes = await Promise.all(
Array.from(this.state.favorites).map(id => this.fetchAnimeByIdGraphQL(id))
);
this.renderAnimeGrid(favoriteAnimes.filter(Boolean), grid);
},

async showHistoryPage() {
const page = document.getElementById('history-page');
page.innerHTML = `
<div class="catalog-header">
<h1>История просмотров</h1>
<p>Аниме, которые вы смотрели</p>
</div>
<div class="catalog-grid" id="historyGrid"></div>
`;

const grid = document.getElementById('historyGrid');

if (!this.state.user) { 
grid.innerHTML = '<div class="empty-state"><h2>Нужна авторизация</h2><p>Войдите в аккаунт, чтобы видеть историю.</p></div>'; 
return; 
}

if (this.state.watchHistory.length === 0) { 
grid.innerHTML = '<div class="empty-state"><h2>Здесь пока пусто</h2><p>Начните просмотр аниме.</p></div>'; 
return; 
}

this.renderAnimeGrid(this.state.watchHistory, grid);
},

handleSearch() {
const query = DOM.searchInput.value.trim();
if (query.length > 1) {
this.navigateTo("search", query);
} else if (this.state.currentView === 'search') {
this.navigateTo("home");
}
},

openAuthModal() {
DOM.modalOverlay.innerHTML = `
<div class="modal-content">
<button class="modal-close-btn" id="modalCloseBtn">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
<line x1="18" y1="6" x2="6" y2="18"/>
<line x1="6" y1="6" x2="18" y2="18"/>
</svg>
</button>
<h2 style="margin-bottom:1.5rem;text-align:center;">Вход в аккаунт</h2>
<form id="loginForm">
<div class="form-group">
<label for="login">Логин</label>
<input type="text" id="login" class="form-input" value="Tester" required>
</div>
<div class="form-group">
<label for="loginPassword">Пароль</label>
<input type="password" id="loginPassword" class="form-input" value="password" required>
</div>
<button type="submit" class="submit-btn">Войти</button>
</form>
</div>
`;

document.getElementById('modalCloseBtn').addEventListener('click', () => this.closeModal());
document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));

DOM.modalOverlay.classList.add("active");
},

closeModal() { 
DOM.modalOverlay.classList.remove("active"); 
setTimeout(() => DOM.modalOverlay.innerHTML = "", 300); 
},

logout() {
this.state.user = null; 
this.state.favorites.clear(); 
this.state.watchHistory = [];
this.state.shikiData = {};
localStorage.removeItem("animeUserData");
this.updateProfileButton();
this.navigateTo('home'); 
this.showToast("Вы вышли из аккаунта");
},

handleLogin(e) {
e.preventDefault();

const nickname = document.getElementById('login').value.trim();
const password = document.getElementById('loginPassword').value.trim();

if (nickname && password) {
this.state.user = { 
nickname: nickname, 
email: `${nickname.toLowerCase()}@example.com` 
};
this.state.shikiData = {
favorites: 3,
watched: 40
};
this.updateProfileButton();
this.saveUserData();
this.showToast("Вход выполнен успешно!");
this.closeModal();

setTimeout(() => {
this.navigateTo('profile');
}, 300);
} else {
this.showToast("Заполните все поля", "error");
}
},
};

window.app = app;
document.addEventListener("DOMContentLoaded", () => app.init());
</script>
</body>
</html>