<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Смотреть аниме онлайн</title>
<meta name="description" content="Ani Jadx -- Твоя мечта">
<link rel="preconnect" href="https://shikimori.one">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
--bg-primary: #0A0B0D;
--bg-secondary: #12131A;
--bg-tertiary: #1A1B23;
--bg-interactive: #23242E;
--bg-interactive-hover: #2C2D38;
--text-primary: #FFFFFF;
--text-secondary: #8B8D98;
--text-tertiary: #5E6070;
--text-bright: #E0E0E0;
--accent-color: var(--text-primary);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

html {
scroll-behavior: smooth;
}

body {
background-color: var(--bg-primary);
color: var(--text-primary);
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
overflow-x: hidden;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
background-image: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.02) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255,255,255,0.01) 0%, transparent 50%);
background-attachment: fixed;
}

a {
text-decoration: none;
color: inherit;
}

ul {
list-style: none;
}

button, input, select {
font-family: inherit;
border: none;
outline: none;
background: none;
}

::selection {
background-color: var(--text-primary);
color: var(--bg-primary);
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { 
background: var(--bg-secondary); 
border-radius: 10px;
}
::-webkit-scrollbar-thumb { 
background: linear-gradient(180deg, var(--bg-interactive) 0%, var(--bg-interactive-hover) 100%);
border-radius: 10px;
border: 2px solid var(--bg-secondary);
}
::-webkit-scrollbar-thumb:hover { 
background: linear-gradient(180deg, var(--bg-interactive-hover) 0%, var(--text-primary) 100%);
}
::-webkit-scrollbar-corner { background: var(--bg-secondary); }

/* Focus states */
a:focus-visible,
button:focus-visible,
input:focus-visible,
select:focus-visible,
.tab-item:focus-visible,
.mobile-nav-item:focus-visible {
  outline: 2px solid rgba(255, 255, 255, 0.18);
  outline-offset: 2px;
  border-radius: 6px;
}

.loading-screen {
position: fixed; inset: 0; background: var(--bg-primary); display: flex;
align-items: center; justify-content: center; flex-direction: column;
gap: 24px; z-index: 9999; transition: opacity 0.3s ease, visibility 0.3s ease;
}
.loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

.loader {
--color-one: var(--text-primary);
--color-two: var(--text-secondary);
--color-three: rgba(255, 255, 255, 0.2);
--color-four: rgba(139, 141, 152, 0.2);
--color-five: rgba(255, 255, 255, 0.1);
--time-animation: 2s;
--size: 1;
position: relative;
border-radius: 50%;
transform: scale(var(--size));
box-shadow: 0 0 25px 0 var(--color-three), 0 20px 50px 0 var(--color-four);
}
.loader::before {
content: "";
position: absolute;
top: 0;
left: 0;
width: 100px;
height: 100px;
border-radius: 50%;
border-top: solid 1px var(--color-one);
border-bottom: solid 1px var(--color-two);
background: linear-gradient(180deg, var(--color-five), var(--color-four));
box-shadow: inset 0 10px 10px 0 var(--color-three), inset 0 -10px 10px 0 var(--color-four);
}
.loader .box {
width: 100px;
height: 100px;
background: linear-gradient(180deg, var(--color-one) 30%, var(--color-two) 70%);
mask: url(#clipping);
-webkit-mask: url(#clipping);
}
.loader svg { position: absolute; }
.loader svg #clipping {
filter: contrast(15);
animation: roundness calc(var(--time-animation) / 2) linear infinite;
}
.loader svg #clipping polygon { filter: blur(7px); }
.loader svg #clipping polygon:nth-child(1) {
transform-origin: 75% 25%;
transform: rotate(90deg);
}
.loader svg #clipping polygon:nth-child(2) {
transform-origin: 50% 50%;
animation: rotation var(--time-animation) linear infinite reverse;
}
.loader svg #clipping polygon:nth-child(3) {
transform-origin: 50% 60%;
animation: rotation var(--time-animation) linear infinite;
animation-delay: calc(var(--time-animation) / -3);
}
.loader svg #clipping polygon:nth-child(4) {
transform-origin: 40% 40%;
animation: rotation var(--time-animation) linear infinite reverse;
}
.loader svg #clipping polygon:nth-child(5) {
transform-origin: 40% 40%;
animation: rotation var(--time-animation) linear infinite reverse;
animation-delay: calc(var(--time-animation) / -2);
}
.loader svg #clipping polygon:nth-child(6) {
transform-origin: 60% 40%;
animation: rotation var(--time-animation) linear infinite;
}
.loader svg #clipping polygon:nth-child(7) {
transform-origin: 60% 40%;
animation: rotation var(--time-animation) linear infinite;
animation-delay: calc(var(--time-animation) / -1.5);
}
@keyframes rotation {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
@keyframes roundness {
0% { filter: contrast(15); }
20% { filter: contrast(3); }
40% { filter: contrast(3); }
60% { filter: contrast(15); }
100% { filter: contrast(15); }
}

.loading-text { color: var(--text-secondary); font-size: 14px; font-weight: 500; letter-spacing: 0.3px; }

.container, .catalog-container, .details-container {
max-width: 1400px; margin: 0 auto; padding: 0 40px;
}

.profile-container {
max-width: 1400px; 
margin: 0 auto; 
padding: 2rem 40px;
}

.page { display: none; min-height: 100vh; padding-top: 80px; }
.page.active { display: block; }
#home-page { padding-top: 0 !important; }

.header {
position: fixed; top: 0; left: 0; width: 100%; display: flex; align-items: center;
justify-content: space-between; padding: 15px 40px; z-index: 100;
background: rgba(10, 11, 13, 0.95); backdrop-filter: blur(16px);
box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
}
.header-center {
position: absolute; left: 50%; transform: translateX(-50%);
display: flex; align-items: center; gap: 16px;
}
.header-logo {
cursor: pointer; transition: transform 0.2s ease;
display: flex; align-items: center; gap: 8px;
}
.header-logo:hover { transform: translateY(-2px); }
.nav-btn {
padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; color: var(--text-secondary);
text-decoration: none; letter-spacing: 0.3px;
position: relative;
}
.nav-btn:hover { 
color: var(--text-primary); 
background: rgba(255, 255, 255, 0.05);
}
.nav-btn.active { 
background: linear-gradient(135deg, var(--bg-interactive), rgba(255, 255, 255, 0.08));
color: var(--text-primary);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.logo-text {
font-size: 18px; font-weight: 700; color: var(--text-primary);
letter-spacing: -0.5px;
}
.header-nav ul { display: flex; align-items: center; gap: 8px; }
.header-nav a {
padding: 10px 18px; border-radius: 6px; font-size: 14px; font-weight: 600;
transition: all 0.2s ease; cursor: pointer; color: var(--text-secondary);
position: relative;
overflow: hidden;
letter-spacing: 0.3px;
}
.header-nav a:hover { color: var(--text-primary); }
.header-nav a.active { 
background: var(--bg-interactive);
color: var(--text-primary);
}

.header-controls { display: flex; align-items: center; gap: 16px; }
.search-wrapper { position: relative; }
.search-wrapper input {
background: var(--bg-tertiary); padding: 12px 16px 12px 40px; border-radius: 8px;
color: var(--text-secondary); font-size: 14px; width: 250px; transition: all 0.2s ease;
border: 1px solid transparent;
font-weight: 500;
letter-spacing: 0.2px;
}
.search-wrapper input:focus {
background-color: var(--bg-tertiary); 
border-color: var(--text-secondary);
box-shadow: 0 0 0 3px rgba(139, 141, 152, 0.1);
}
.search-wrapper svg {
position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
width: 18px; height: 18px; fill: var(--text-secondary); pointer-events: none;
}
.user-avatar-btn {
width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-interactive);
cursor: pointer; background-size: cover; background-position: center; transition: all 0.2s ease;
display: grid; place-items: center; font-weight: 700; font-size: 16px; color: var(--text-primary);
border: 1px solid var(--bg-tertiary);
position: relative;
overflow: hidden;
}
.user-avatar-btn:hover { 
background-color: var(--bg-interactive-hover);
border-color: var(--text-secondary);
}

.hero-section {
height: 550px;
position: relative;
display: flex;
align-items: flex-end;
overflow: hidden;
margin-top: 70px;
border-radius: 0 0 24px 24px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
.hero-bg {
position: absolute;
inset: 0;
background-size: cover;
background-position: center;
z-index: 1;
transition: opacity 0.4s ease;
opacity: 0;
}
.hero-bg.loaded { opacity: 1; }
.hero-bg::after {
content: '';
position: absolute;
inset: 0;
background: linear-gradient(to top, rgba(10, 11, 13, 1) 0%, rgba(10, 11, 13, 0.85) 20%, rgba(10, 11, 13, 0.4) 50%, transparent 70%);
}
.hero-content-wrapper {
position: relative;
z-index: 2;
width: 100%;
padding-bottom: 60px;
}
.hero-text {
max-width: 650px;
text-align: left;
}
.hero-title, .hero-meta, .hero-description, .hero-actions { opacity: 1; transform: none; }
.hero-title {
font-size: 32px;
font-weight: 800;
line-height: 1.25;
margin-bottom: 12px;
letter-spacing: -0.01em;
text-shadow: none;
}
.hero-meta {
display: flex;
align-items: center;
gap: 12px;
font-size: 14px;
color: var(--text-secondary);
margin-bottom: 16px;
font-weight: 500;
}
.hero-meta span:not(:last-child)::after { content: '•'; margin-left: 12px; }
.hero-description {
font-size: 14px;
line-height: 1.6;
color: var(--text-secondary);
margin-bottom: 20px;
display: -webkit-box;
-webkit-line-clamp: 3;
-webkit-box-orient: vertical;
overflow: hidden;
max-width: 580px;
}
.hero-actions { 
display: flex; 
align-items: center; 
gap: 16px; 
}

.player-container {
width: 100%;
aspect-ratio: 16/9;
background: #0f1015;
border: 1px solid rgba(255,255,255,0.06);
border-radius: 10px;
overflow: hidden;
position: relative;
box-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
}

.player-header {
display: flex;
gap: 10px;
padding: 10px;
background: transparent;
}

.player-btn {
padding: 10px 18px;
border-radius: 8px;
font-weight: 600;
font-size: 13px;
color: var(--text-secondary);
background: var(--bg-interactive);
border: 1px solid rgba(255, 255, 255, 0.08);
cursor: pointer;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
letter-spacing: 0.3px;
position: relative;
overflow: hidden;
}

.player-btn::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
border-radius: 50%;
background: rgba(255, 255, 255, 0.1);
transform: translate(-50%, -50%);
transition: width 0.6s, height 0.6s;
}

.player-btn:hover::before {
width: 300px;
height: 300px;
}

.player-btn:hover {
color: var(--text-primary);
background: var(--bg-interactive-hover);
border-color: rgba(255, 255, 255, 0.15);
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.player-btn.active {
color: var(--text-primary);
background: linear-gradient(135deg, var(--bg-interactive-hover), rgba(255, 255, 255, 0.08));
border-color: rgba(255, 255, 255, 0.2);
box-shadow: 0 0 20px rgba(255, 255, 255, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.player-frame {
position: relative;
width: 100%;
padding-top: 56.25%;
}

.player-frame iframe {
position: absolute;
inset: 0;
width: 100%;
height: 100%;
border: 0;
}

.player-note {
padding: 10px;
color: var(--text-tertiary);
font-size: 12px;
}

.btn {
padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600;
display: inline-flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; 
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
border: 1px solid transparent;
position: relative;
overflow: hidden;
letter-spacing: 0.4px;
}
.btn::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
border-radius: 50%;
background: rgba(255, 255, 255, 0.15);
transform: translate(-50%, -50%);
transition: width 0.5s, height 0.5s;
z-index: 0;
}
.btn:hover::before {
width: 300px;
height: 300px;
}
.btn span,
.btn svg {
position: relative;
z-index: 1;
}
.btn-primary { 
background: rgba(255, 255, 255, 0.05);
color: var(--text-primary);
border: 1px solid rgba(255, 255, 255, 0.2);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.btn-primary:hover { 
border-color: rgba(255, 255, 255, 0.4);
background: rgba(255, 255, 255, 0.1);
transform: translateY(-2px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.1);
}
.btn-primary:active { 
transform: translateY(0);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-secondary { 
background: linear-gradient(135deg, var(--bg-interactive), var(--bg-interactive-hover)); 
color: var(--text-primary);
border: 1px solid rgba(255, 255, 255, 0.1);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.btn-secondary:hover { 
background: linear-gradient(135deg, var(--bg-interactive-hover), var(--bg-interactive));
border-color: rgba(255, 255, 255, 0.2);
transform: translateY(-2px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
}
.btn-secondary:active { 
transform: translateY(0);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.btn-outline {
background: transparent;
color: var(--text-primary);
border: 1px solid var(--text-secondary);
}
.btn-outline:hover {
border-color: var(--text-primary);
background: rgba(255, 255, 255, 0.05);
}

.btn svg { width: 18px; height: 18px; fill: currentColor; }

.page-loader { display: flex; justify-content: center; align-items: center; min-height: 50vh; }
.row { margin: 60px 0; }
@media (max-width: 768px) { .row { margin: 40px 0; } }
.row-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
.row-title { font-size: 24px; font-weight: 700; letter-spacing: -0.02em; }
.row-link {
 font-size: 14px; font-weight: 600; color: var(--text-secondary); display: flex;
 align-items: center; gap: 6px; transition: color 0.2s ease;
 letter-spacing: 0.2px;
}
.row-link:hover { color: var(--text-primary); }
.row-link svg { width: 16px; height: 16px; fill: currentColor; }

.card-list, .catalog-grid {
display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;
}
.anime-card { 
 display: block; 
 transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 cursor: pointer;
 position: relative;
}
.anime-card:hover { 
 transform: translateY(-8px) scale(1.02); 
}
.anime-card-poster {
 position: relative; margin-bottom: 12px; overflow: hidden;
 border-radius: 14px; background: var(--bg-tertiary);
 border: 1px solid rgba(255, 255, 255, 0.06);
 aspect-ratio: 2/3;
 box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2);
 transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.anime-card:hover .anime-card-poster {
 box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 4px 16px rgba(0, 0, 0, 0.3);
 border-color: rgba(255, 255, 255, 0.12);
}
.anime-card-poster::after {
 content: '';
 position: absolute;
 inset: 0;
 background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.25) 100%);
 z-index: 2;
 pointer-events: none;
 border-radius: 12px;
}
.anime-card-poster img {
 width: 100%; height: 100%; 
 object-fit: cover; border-radius: 14px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 display: block;
}
.anime-card:hover .anime-card-poster img { 
 transform: scale(1.05); 
 filter: brightness(1.08) contrast(1.02); 
}
.anime-card-badge {
position: absolute; top: 8px; left: 8px; padding: 6px 12px;
background: rgba(255, 255, 255, 0.95); color: var(--bg-primary);
border-radius: 6px; font-size: 11px; font-weight: 700; z-index: 3;
backdrop-filter: blur(4px);
letter-spacing: 0.3px;
}
.anime-card-play {
 position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
 background: rgba(0, 0, 0, 0.35);
 width: 48px; height: 48px; margin: auto;
 opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; 
 z-index: 3;
 transform: scale(0.7);
 border-radius: 50%;
 backdrop-filter: blur(3px);
}
.anime-card:hover .anime-card-play { opacity: 1; transform: scale(1); }
.anime-card-play svg { width: 24px; height: 24px; fill: white; }
.anime-card-title {
font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden;
text-overflow: ellipsis; color: var(--text-secondary); transition: color 0.2s ease; margin-bottom: 4px;
letter-spacing: 0.2px;
}
.anime-card:hover .anime-card-title { color: var(--text-primary); }
.anime-card-info { font-size: 12px; color: var(--text-tertiary); font-weight: 500; letter-spacing: 0.2px; }
.anime-card-info-rating { display: flex; align-items: center; gap: 4px; }
.anime-card-info-rating svg { width: 14px; height: 14px; fill: var(--text-secondary); }

.catalog-header, .details-page-header, .profile-page-header {
margin-bottom: 40px;
animation: fadeInUp 0.6s ease-out;
}
.catalog-header h1, .details-page-header h1, .profile-page-header h1 {
font-size: 36px; font-weight: 800; margin-bottom: 12px; letter-spacing: -0.02em;
background: linear-gradient(135deg, var(--text-primary), rgba(255, 255, 255, 0.8));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}
.catalog-header p, .details-page-header p, .profile-page-header p {
font-size: 16px; color: var(--text-secondary); max-width: 600px; letter-spacing: 0.2px;
}

.filters { 
 display: flex; 
 flex-wrap: wrap; 
 gap: 16px; 
 margin-bottom: 40px; 
 align-items: flex-start;
}

.catalog-pagination { display: flex; align-items: center; justify-content: center; gap: 12px; margin: 16px 0 40px; }
.page-btn { padding: 8px 12px; border-radius: 6px; background: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--bg-interactive-hover); font-weight: 700; cursor: pointer; }
.page-btn:hover { background: var(--bg-interactive-hover); }
.page-btn:disabled { opacity: .5; cursor: not-allowed; }
.page-indicator { color: var(--text-secondary); font-weight: 700; }

.filter-select {
  position: relative;
  min-width: 200px;
}

.filter-select select {
  width: 100%;
  background: var(--bg-interactive);
  border: 1px solid var(--bg-interactive-hover);
  border-radius: 8px;
  padding: 12px 40px 12px 16px;
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

/* Custom select (closed by default) */
.custom-select { position: relative; min-width: 160px; max-width: 180px; z-index: 1; flex: 0 0 auto; }
.custom-select .custom-options { width: 100%; }
.custom-select.open { z-index: 50; }
.custom-select-trigger {
  width: 100%; display: flex; align-items: center; justify-content: space-between;
  background: var(--bg-interactive); border: none;
  border-radius: 6px; padding: 8px 10px; color: var(--text-primary); font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all 0.2s ease; letter-spacing: 0.2px;
}
.custom-select-trigger:hover { background: var(--bg-interactive-hover); }
.custom-select-trigger svg { width: 14px; height: 14px; fill: var(--text-secondary); transition: transform 0.2s ease; }
.custom-select.open .custom-select-trigger svg { transform: rotate(180deg); }
.custom-options {
  position: absolute; top: calc(100% + 8px); left: 0; right: 0; max-height: 240px; overflow: auto;
  background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 8px;
  display: none; z-index: 200; box-shadow: 0 16px 40px rgba(0,0,0,0.45);
}
.custom-select.open .custom-options { display: block; }
.custom-option { 
  padding: 8px 10px; border-radius: 6px; color: var(--text-secondary); font-weight: 600; font-size: 12px; cursor: pointer; 
  transition: background 0.15s ease, color 0.15s ease; letter-spacing: 0.2px;
}
.custom-option:hover { background: var(--bg-interactive-hover); color: var(--text-primary); }
.custom-option.active { background: var(--bg-interactive); color: var(--text-primary); }
.custom-search { position: sticky; top: 0; padding: 6px; background: var(--bg-secondary); z-index: 1; }
.custom-search input { width: 100%; background: var(--bg-interactive); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 6px 8px; color: var(--text-primary); font-size: 12px; font-weight: 600; outline: none; }

.empty-state {
text-align: center; padding: 80px 20px; background: transparent; border-radius: 12px;
}
.empty-state h2 { font-size: 24px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.01em; }
.empty-state p { color: var(--text-secondary); margin-bottom: 24px; letter-spacing: 0.2px; }

#profile-page-grid {
display: grid;
grid-template-columns: 280px 1fr;
gap: 30px;
}
.profile-sidebar {
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
border-radius: 16px;
padding: 28px;
align-self: start;
text-align: center;
border: 1px solid rgba(255, 255, 255, 0.08);
backdrop-filter: blur(16px);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}
.profile-avatar {
width: 120px; height: 120px; border-radius: 50%; 
background: linear-gradient(135deg, var(--bg-interactive), var(--bg-interactive-hover));
margin: 0 auto 20px;
background-size: cover; display: grid; place-items: center;
font-size: 48px; font-weight: 700;
border: 4px solid rgba(255, 255, 255, 0.15);
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), inset 0 2px 8px rgba(255, 255, 255, 0.1);
transition: all 0.3s ease;
}
.profile-avatar:hover {
transform: scale(1.05);
box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4), inset 0 2px 8px rgba(255, 255, 255, 0.15);
}
.profile-sidebar h1 { font-size: 22px; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.01em; }
.profile-sidebar p { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; letter-spacing: 0.2px; }
.profile-stats { display: flex; justify-content: space-around; margin-bottom: 24px; }
.profile-stat { display: flex; flex-direction: column; align-items: center; }
.profile-stat-value { font-size: 24px; font-weight: 800; margin-bottom: 2px; letter-spacing: -0.01em; }
.profile-stat-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.2px; }
.profile-main-content {
display: flex;
flex-direction: column;
gap: 30px;
}
.profile-section { 
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
border-radius: 16px; 
padding: 28px;
border: 1px solid rgba(255, 255, 255, 0.08);
backdrop-filter: blur(16px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
transition: all 0.3s ease;
}
.profile-section:hover {
border-color: rgba(255, 255, 255, 0.12);
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}
.profile-section h2 { 
font-size: 20px; 
font-weight: 700; 
margin-bottom: 20px;
display: flex;
align-items: center;
justify-content: space-between;
letter-spacing: -0.01em;
}
.profile-section h2 a {
font-size: 14px;
color: var(--text-secondary);
font-weight: 600;
transition: color 0.2s ease;
letter-spacing: 0.2px;
}
.profile-section h2 a:hover { color: var(--text-primary); }
.profile-section .card-list { 
grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
gap: 16px;
}

.modal-overlay {
position: fixed; inset: 0; background: rgba(0, 0, 0, .9); backdrop-filter: blur(10px);
z-index: 2000; display: flex; align-items: center; justify-content: center;
opacity: 0; pointer-events: none; transition: opacity .3s ease;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal-content {
background: var(--bg-secondary); border-radius: 16px; padding: 2rem;
width: 100%; max-width: 400px; position: relative;
transform: scale(.9); transition: transform .3s ease; 
border: 1px solid rgba(255, 255, 255, 0.05);
backdrop-filter: blur(20px);
}
.modal-overlay.active .modal-content { transform: scale(1); }

.modal-content.large {
max-width: 600px;
}

.settings-modal .modal-content {
max-width: 550px;
}
.modal-close-btn {
position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px;
background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; color: var(--text-secondary);
display: flex; align-items: center; justify-content: center; transition: all .3s ease;
border: 1px solid transparent;
}
.modal-close-btn:hover { 
background: var(--bg-interactive-hover);
color: var(--text-primary);
transform: none;
border-color: var(--text-secondary);
}

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: .4rem; font-weight: 500; font-size: .85rem; letter-spacing: 0.2px; }
.form-input {
width: 100%; background: var(--bg-tertiary); border: 1px solid var(--bg-interactive);
border-radius: 8px; padding: .7rem 1rem; color: var(--text-primary);
font-size: .9rem; transition: all .3s ease; font-weight: 500; letter-spacing: 0.2px;
}
.form-input:focus { 
border-color: var(--accent-color); 
background: var(--bg-primary);
box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
}
.submit-btn {
width: 100%; background: var(--accent-color); color: var(--bg-primary); border-radius: 8px;
padding: .8rem; font-size: .95rem; font-weight: 600; cursor: pointer; 
transition: all .3s ease;
border: 1px solid var(--accent-color);
letter-spacing: 0.3px;
}
.submit-btn:hover { 
background: rgba(255, 255, 255, 0.9);
transform: translateY(-2px);
box-shadow: 0 8px 16px rgba(255, 255, 255, 0.1);
}
.submit-btn:active { transform: translateY(0); }
.submit-btn:disabled { opacity: .5; cursor: not-allowed; }

/* Settings Modal Styles */
.settings-section {
margin-bottom: 2rem;
}

.settings-section:last-child {
margin-bottom: 0;
}

.settings-section h3 {
font-size: 16px;
font-weight: 700;
margin-bottom: 1rem;
color: var(--text-primary);
letter-spacing: 0.2px;
}

.avatar-upload-wrapper {
display: flex;
align-items: center;
gap: 1.5rem;
margin-bottom: 1rem;
}

.avatar-upload-controls {
flex: 1;
overflow: hidden;
}

.avatar-preview {
width: 80px;
height: 80px;
border-radius: 50%;
background: linear-gradient(135deg, var(--bg-interactive), var(--bg-interactive-hover));
display: grid;
place-items: center;
font-size: 32px;
font-weight: 700;
border: 2px solid rgba(255, 255, 255, 0.1);
background-size: cover;
background-position: center;
overflow: hidden;
}

.avatar-preview img {
width: 100%;
height: 100%;
object-fit: cover;
}

.avatar-upload-controls {
flex: 1;
}

.file-input-wrapper {
position: relative;
overflow: hidden;
display: inline-block;
}

.file-input-wrapper input[type="file"] {
position: absolute;
left: -9999px;
}

.file-input-label {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 10px 18px;
background: var(--bg-interactive);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 8px;
color: var(--text-primary);
font-size: 13px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
letter-spacing: 0.3px;
}

.file-input-label:hover {
background: var(--bg-interactive-hover);
border-color: rgba(255, 255, 255, 0.2);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.file-input-label svg {
width: 16px;
height: 16px;
fill: currentColor;
}

.form-group textarea {
width: 100%;
background: var(--bg-tertiary);
border: 1px solid var(--bg-interactive);
border-radius: 8px;
padding: 0.7rem 1rem;
color: var(--text-primary);
font-size: 0.9rem;
transition: all 0.3s ease;
font-weight: 500;
letter-spacing: 0.2px;
resize: vertical;
min-height: 100px;
font-family: inherit;
}

.form-group textarea:focus {
border-color: var(--accent-color);
background: var(--bg-primary);
box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
outline: none;
}

.privacy-toggle {
display: flex;
align-items: center;
justify-content: space-between;
padding: 12px 16px;
background: var(--bg-tertiary);
border-radius: 8px;
margin-bottom: 12px;
border: 1px solid rgba(255, 255, 255, 0.05);
transition: all 0.3s ease;
}

.privacy-toggle:hover {
background: var(--bg-interactive);
border-color: rgba(255, 255, 255, 0.1);
}

.privacy-toggle-label {
display: flex;
flex-direction: column;
gap: 4px;
}

.privacy-toggle-label strong {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
letter-spacing: 0.2px;
}

.privacy-toggle-label span {
font-size: 12px;
color: var(--text-secondary);
letter-spacing: 0.2px;
}

/* Toggle Switch */
.toggle-switch {
position: relative;
width: 48px;
height: 24px;
}

.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}

.toggle-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: var(--bg-interactive);
border: 1px solid rgba(255, 255, 255, 0.1);
transition: 0.4s;
border-radius: 24px;
}

.toggle-slider:before {
position: absolute;
content: "";
height: 16px;
width: 16px;
left: 3px;
bottom: 3px;
background-color: var(--text-secondary);
transition: 0.4s;
border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
background-color: rgba(76, 175, 80, 0.3);
border-color: rgba(76, 175, 80, 0.5);
}

.toggle-switch input:checked + .toggle-slider:before {
transform: translateX(24px);
background-color: #4caf50;
}

.toggle-slider:hover {
border-color: rgba(255, 255, 255, 0.2);
}

.details-grid {
display: grid;
grid-template-columns: 280px 1fr;
gap: 40px;
}
.details-main-content .card-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 180px));
  gap: 20px;
  justify-content: start;
}
.details-sidebar { align-self: start; }
.details-poster {
position: relative;
margin-bottom: 20px;
overflow: hidden;
border-radius: 16px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.details-poster:hover {
transform: translateY(-4px) scale(1.02);
box-shadow: 0 20px 48px rgba(0, 0, 0, 0.6);
}
.details-poster img { 
width: 100%; 
border-radius: 16px; 
border: 1px solid rgba(255, 255, 255, 0.08);
display: block;
box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.details-poster:hover img {
transform: scale(1.03);
filter: brightness(1.05) contrast(1.02);
}
.details-poster::after {
content: '';
position: absolute;
bottom: -16px;
left: 50%;
transform: translateX(-50%);
width: 90%;
height: 50px;
background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.4) 0%, transparent 70%);
filter: blur(12px);
z-index: -1;
}
.details-main-content h1 { font-size: 36px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.02em; }
.details-main-content h2 { font-size: 18px; color: var(--text-secondary); font-weight: 500; margin-bottom: 24px; letter-spacing: 0.2px; }
.details-meta {
display: grid; 
grid-template-columns: 1fr;
gap: 14px;
font-size: 14px;
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
padding: 24px;
border-radius: 12px;
border: 1px solid rgba(255, 255, 255, 0.08);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
backdrop-filter: blur(10px);
}
.details-meta-row { display: flex; justify-content: space-between; }
.details-meta-label { color: var(--text-secondary); font-weight: 500; letter-spacing: 0.2px; }
.details-meta-value { font-weight: 600; text-align: right; letter-spacing: 0.2px; }
.details-meta-value.genres { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
.details-meta-value.genres span { 
background: var(--bg-interactive); 
padding: 6px 12px; 
border-radius: 20px; 
font-size: 12px;
border: 1px solid rgba(255, 255, 255, 0.05);
transition: all 0.2s ease;
letter-spacing: 0.2px;
}
.details-meta-value.genres span:hover {
background: var(--bg-interactive-hover);
border-color: var(--text-secondary);
}
.details-actions { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 24px; }

.details-description {
line-height: 1.8;
color: var(--text-bright);
background: linear-gradient(135deg, rgba(18, 19, 26, 0.5), rgba(26, 27, 35, 0.3));
padding: 28px;
border-radius: 12px;
border: 1px solid rgba(255, 255, 255, 0.08);
letter-spacing: 0.2px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(10px);
}
.details-description p {
margin-bottom: 16px;
}

.tabs { display: flex; gap: 1.8rem; margin-bottom: 1.8rem; border-bottom: 1px solid rgba(255, 255, 255, 0.08); overflow-x: auto; scrollbar-width: none; }
.tabs::-webkit-scrollbar { display: none; }
.tab-item {
padding: .8rem 0; color: var(--text-secondary); font-size: .95rem; font-weight: 600;
cursor: pointer; position: relative; transition: color .3s ease; white-space: nowrap;
letter-spacing: 0.2px;
}
.tab-item.active, .tab-item:hover { color: var(--text-primary); }
.tab-item::after {
content: '';
position: absolute;
bottom: -1px;
left: 0;
width: 0;
height: 2px;
background: var(--text-primary);
border-radius: 2px;
transition: width .3s ease;
}
.tab-item.active::after { width: 100%; }
.tab-content { display: none; }
.tab-content.active { display: block; }

.player-container {
width: 100%;
aspect-ratio: 16/9;
background: #0f1015;
border: 1px solid rgba(255,255,255,0.06);
border-radius: 10px;
overflow: hidden;
position: relative;
box-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
}

.player-container iframe {
width: 100%;
height: 100%;
border: none;
background: #000;
}

.pjs-container {
width: 100% !important;
height: 100% !important;
border-radius: 8px !important;
overflow: hidden !important;
}

.pjs-video {
border-radius: 8px !important;
}

/* AnimeBest стили для плеера */
.embed-responsive {
position: relative;
display: block;
width: 100%;
padding: 0;
overflow: hidden;
}

.embed-responsive-16by9 {
padding-bottom: 56.25%;
}

.embed-responsive-item {
position: absolute;
top: 0;
bottom: 0;
left: 0;
width: 100%;
height: 100%;
border: 0;
}

.player-iframe {
background: #000;
border-radius: 8px;
overflow: hidden;
}

.padding-5 {
padding: 5px;
}

#initPlayer {
width: 100%;
height: 100%;
background: #1a1b23;
border-radius: 8px;
}

#shadow {
display: none;
}

.player-switch-btn {
transition: all 0.3s ease;
font-weight: 500;
}

.player-switch-btn:hover {
transform: translateY(-1px);
box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.player-switch-btn.active {
box-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
}

.favorite-btn {
display: flex;
align-items: center;
gap: 8px;
padding: 12px 20px;
border-radius: 8px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
background: linear-gradient(135deg, var(--bg-interactive), var(--bg-interactive-hover));
color: var(--text-primary);
border: 1px solid rgba(255, 255, 255, 0.1);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
position: relative;
overflow: hidden;
letter-spacing: 0.3px;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.favorite-btn::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
border-radius: 50%;
background: rgba(255, 255, 255, 0.1);
transform: translate(-50%, -50%);
transition: width 0.5s, height 0.5s;
z-index: 0;
}
.favorite-btn:hover::before {
width: 200px;
height: 200px;
}
.favorite-btn:hover {
background: linear-gradient(135deg, var(--bg-interactive-hover), var(--bg-interactive));
border-color: rgba(255, 255, 255, 0.2);
transform: translateY(-2px);
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
}
.favorite-btn:active {
transform: translateY(0);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.favorite-btn.active {
background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.15));
border-color: rgba(255, 107, 107, 0.4);
color: #FF6B6B;
box-shadow: 0 0 20px rgba(255, 107, 107, 0.2), 0 4px 16px rgba(255, 107, 107, 0.1);
}
.favorite-btn span,
.favorite-btn svg {
position: relative;
z-index: 1;
}
.favorite-btn svg { width: 18px; height: 18px; fill: currentColor; }

.toast {
position: fixed; bottom: 2rem; right: 2rem; background: var(--bg-secondary);
padding: 1rem 1.5rem; border-radius: 10px; 
box-shadow: 0 12px 28px -5px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,0.05);
z-index: 3000; opacity: 0; transform: translateY(20px) scale(0.9); 
transition: all .4s cubic-bezier(0.4, 0, 0.2, 1);
border: 1px solid var(--bg-tertiary); max-width: 300px;
backdrop-filter: blur(10px);
font-weight: 500;
letter-spacing: 0.2px;
}
.toast.show { 
opacity: 1; 
transform: translateY(0) scale(1); 
}
.toast.success { 
border-left: 4px solid #4caf50;
box-shadow: 0 12px 28px -5px rgba(76, 175, 80, 0.3), 0 0 0 1px rgba(76, 175, 80, 0.2);
}
.toast.error { 
border-left: 4px solid #f44336;
box-shadow: 0 12px 28px -5px rgba(244, 67, 54, 0.3), 0 0 0 1px rgba(244, 67, 54, 0.2);
}

#search-page .search-header {
text-align: center;
margin-bottom: 40px;
}
#search-page .search-header h1 {
font-size: 28px;
font-weight: 700;
letter-spacing: -0.01em;
}
#search-page .search-header h1 span {
color: var(--text-primary);
font-weight: 800;
}
#search-page .search-header p {
font-size: 16px;
color: var(--text-secondary);
margin-top: 8px;
letter-spacing: 0.2px;
}

.mobile-nav {
display: none;
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: rgba(18, 19, 26, 0.95);
backdrop-filter: blur(10px);
border-top: 1px solid rgba(255, 255, 255, 0.05);
padding: 8px 0;
z-index: 1000;
}
.mobile-nav-list {
display: flex;
justify-content: space-around;
align-items: center;
}
.mobile-nav-item {
display: flex;
flex-direction: column;
align-items: center;
gap: 4px;
padding: 8px 16px;
color: var(--text-secondary);
font-size: 11px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
letter-spacing: 0.3px;
}
.mobile-nav-item svg {
width: 22px;
height: 22px;
fill: currentColor;
}
.mobile-nav-item.active {
color: var(--text-primary);
}
/* Mobile active underline */
.mobile-nav-item { position: relative; }
.mobile-nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  width: 28px;
  height: 2px;
  background: var(--text-primary);
  border-radius: 1px;
}

.settings-container {
padding: 2rem 0;
max-width: 700px;
margin: 0 auto;
}

.back-btn {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 10px 18px;
border-radius: 8px;
background: var(--bg-interactive);
color: var(--text-primary);
border: 1px solid rgba(255, 255, 255, 0.1);
cursor: pointer;
transition: all 0.3s ease;
font-size: 14px;
font-weight: 600;
margin-bottom: 24px;
}

.back-btn:hover {
background: var(--bg-interactive-hover);
border-color: rgba(255, 255, 255, 0.2);
transform: translateX(-4px);
}

.back-btn svg {
width: 18px;
height: 18px;
}

.settings-page-content {
background: linear-gradient(135deg, var(--bg-secondary), rgba(18, 19, 26, 0.8));
border-radius: 16px;
padding: 32px;
border: 1px solid rgba(255, 255, 255, 0.08);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
.anime-card {
animation: fadeInUp 0.4s ease-out;
animation-fill-mode: both;
}
.anime-card:nth-child(1) { animation-delay: 0.05s; }
.anime-card:nth-child(2) { animation-delay: 0.1s; }
.anime-card:nth-child(3) { animation-delay: 0.15s; }
.anime-card:nth-child(4) { animation-delay: 0.2s; }
.anime-card:nth-child(5) { animation-delay: 0.25s; }
.anime-card:nth-child(6) { animation-delay: 0.3s; }
.anime-card:nth-child(7) { animation-delay: 0.35s; }
.anime-card:nth-child(8) { animation-delay: 0.4s; }

@keyframes shimmer {
0% { background-position: -1000px 0; }
100% { background-position: 1000px 0; }
}
.page-loader {
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
background-size: 1000px 100%;
animation: shimmer 2s infinite;
}

.page {
animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}
.mobile-nav-item.active svg {
animation: pulse 2s ease-in-out infinite;
}

@media (max-width: 1024px) {
.header-nav { display: none; }
.details-grid { grid-template-columns: 220px 1fr; }
}
@media (max-width: 768px) {
  .container, .catalog-container, .profile-container, .settings-container {
padding: 2rem 20px;
}
  .header { padding: 15px 20px; }
  .header-nav { display: none; }
  .mobile-nav { display: block; }
  body { padding-bottom: 70px; }
  .search-wrapper input { width: 150px; }
  .hero-title { font-size: 26px; }
  .filters { flex-direction: column; }
  .filter-select { width: 100%; }
  .card-list, .catalog-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
  .details-grid { grid-template-columns: 1fr; text-align: center; }
  .details-sidebar { max-width: 260px; margin: 0 auto; }
  .details-meta-row { justify-content: space-between; }
  .details-meta-value { text-align: right; }
  .details-actions { justify-content: center; }
  #profile-page-grid { grid-template-columns: 1fr; }
  .details-main-content .card-list { grid-template-columns: repeat(auto-fill, minmax(140px, 140px)); justify-content: start; }
}

</style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loader">
      <div class="box"></div>
      <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
        <defs>
          <filter id="clipping">
            <feGaussianBlur in="SourceGraphic" stdDeviation="0" result="blur" />
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 19 -9" result="goo" />
            <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
          </filter>
        </defs>
        <clipPath id="clipping" clipPathUnits="objectBoundingBox">
          <polygon points="0.35 0.15, 0.45 0.05, 0.55 0.15, 0.65 0.05, 0.75 0.15"></polygon>
          <polygon points="0.15 0.35, 0.05 0.45, 0.15 0.55, 0.05 0.65, 0.15 0.75"></polygon>
          <polygon points="0.35 0.85, 0.45 0.95, 0.55 0.85, 0.65 0.95, 0.75 0.85"></polygon>
          <polygon points="0.85 0.35, 0.95 0.45, 0.85 0.55, 0.95 0.65, 0.85 0.75"></polygon>
          <polygon points="0.5 0.5"></polygon>
          <polygon points="0.5 0.5"></polygon>
          <polygon points="0.5 0.5"></polygon>
        </clipPath>
      </svg>
    </div>
    <div class="loading-text">Загрузка...</div>
  </div>

  <header class="header" id="header">
    <div class="header-nav">
      <ul>
      </ul>
    </div>
    <div class="header-center">
      <a href="#home" data-nav="home" class="nav-btn">Главная</a>
      <div class="header-logo">
        <svg viewBox="0 0 40 40" width="32" height="32" aria-label="AniJadx">
          <defs>
            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#2A2B35"/>
              <stop offset="1" stop-color="#1A1B23"/>
            </linearGradient>
          </defs>
          <rect x="2" y="2" width="36" height="36" rx="8" fill="url(#g1)" stroke="#333"/>
          <path d="M20 9 L30 31 H26.5 L24.2 26 H15.8 L13.5 31 H10 L20 9 Z M21.6 22 L20 18.8 L18.4 22 H21.6 Z" fill="#ffffff"/>
        </svg>
        <span class="logo-text">AniJadx</span>
      </div>
      <a href="#catalog" data-nav="catalog" class="nav-btn">Каталог</a>
    </div>
    <div class="header-nav">
      <ul>
      </ul>
    </div>
    <div class="header-controls">
      <div class="search-wrapper">
        <svg viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L21.5,20L20,21.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <input type="text" id="searchInput" placeholder="Поиск аниме...">
      </div>
      <button class="user-avatar-btn" id="profileBtn"></button>
    </div>
  </header>

  <nav class="mobile-nav" id="mobileNav">
    <ul class="mobile-nav-list">
      <li class="mobile-nav-item" data-nav="home">
        <svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg>
        <span>Главная</span>
      </li>
      <li class="mobile-nav-item" data-nav="catalog">
        <svg viewBox="0 0 24 24"><path d="M4,6H2V20A2,2 0 0,0 4,22H18V20H4V6M20,2H8A2,2 0 0,0 6,4V16A2,2 0 0,0 8,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H8V4H20V16M13,14L18,10.5L13,7V14Z"/></svg>
        <span>Каталог</span>
      </li>
      <li class="mobile-nav-item" data-nav="favorites">
        <svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/></svg>
        <span>Избранное</span>
      </li>
      <li class="mobile-nav-item" data-nav="profile">
        <svg viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
        <span>Профиль</span>
      </li>
    </ul>
  </nav>

  <main id="home-page" class="page active">
    <section class="hero-section">
      <div class="hero-bg"></div>
      <div class="hero-content-wrapper">
        <div class="container">
          <div class="hero-content">
            <div class="hero-text">
              <h1 class="hero-title"></h1>
              <div class="hero-meta"></div>
              <p class="hero-description"></p>
            </div>
            <div class="hero-actions"></div>
          </div>
        </div>
      </div>
    </section>
    <div class="container" id="home-content"></div>
  </main>
  <main id="catalog-page" class="catalog-container page"></main>
  <main id="details-page" class="details-container page"></main>
  <main id="profile-page" class="profile-container page"></main>
  <main id="settings-page" class="settings-container page"></main>
  <main id="search-page" class="catalog-container page"></main>
  <main id="favorites-page" class="catalog-container page"></main>
  <main id="history-page" class="catalog-container page"></main>

  <div id="modalOverlay" class="modal-overlay"></div>

<script>
const API_BASE = "https://shikimori.one";
const API_GRAPHQL = `${API_BASE}/api/graphql`;
const PLACEHOLDER_IMAGE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2' height='3' viewBox='0 0 2 3'%3E%3Crect width='2' height='3' fill='%231A1B23'/%3E%3C/svg%3E";

const API_RATE_LIMITER = {
  requests: [],
  maxRequests: 5,
  timeWindow: 1000,
  
  canMakeRequest() {
    const now = Date.now();
    this.requests = this.requests.filter(time => now - time < this.timeWindow);
    return this.requests.length < this.maxRequests;
  },
  
  addRequest() {
    this.requests.push(Date.now());
  },
  
  async waitForSlot() {
    while (!this.canMakeRequest()) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
    this.addRequest();
  }
};

const DOM = {
pages: document.querySelectorAll('.page'),
header: document.getElementById("header"),
navLinks: document.querySelectorAll('.header-nav a'),
mobileNavItems: document.querySelectorAll('.mobile-nav-item'),
searchInput: document.getElementById("searchInput"),
profileBtn: document.getElementById("profileBtn"),
modalOverlay: document.getElementById("modalOverlay"),
loadingScreen: document.getElementById("loadingScreen"),
};

const app = {
state: {
currentView: "home",
heroItems: [], heroIndex: 0, heroInterval: null,
user: null,
favorites: new Set(['11757', '1', '16498']),
watchHistory: [],
shikiData: {},
cache: new Map(),
selectedGenre: '',
selectedOrder: 'popularity',
selectedCategory: 'all',
catalogPage: 1,
},

async init() {
this.updatePagePadding();
this.attachEventListeners();
this.loadUserData();
this.handleRoute();
window.addEventListener('load', () => setTimeout(() => DOM.loadingScreen.classList.add('hidden'), 300));
},

updatePagePadding() {
const headerHeight = DOM.header.offsetHeight;
DOM.pages.forEach(page => page.style.paddingTop = `${headerHeight + 40}px`);
},

attachEventListeners() {
window.addEventListener("popstate", () => this.handleRoute());
window.addEventListener("resize", this.debounce(() => { this.updatePagePadding(); }, 100));
DOM.searchInput.addEventListener("input", this.debounce(() => this.handleSearch(), 400));
DOM.profileBtn.addEventListener('click', () => {
if (this.state.user && this.state.user.nickname) {
this.navigateTo('profile');
} else {
this.openAuthModal();
}
});

document.querySelector('.header-logo')?.addEventListener('click', () => {
this.navigateTo('home');
});

document.addEventListener("click", e => {
const navLink = e.target.closest('[data-nav]');
if (navLink) { e.preventDefault(); this.navigateTo(navLink.dataset.nav); }

const animeCard = e.target.closest('.anime-card[data-id]');
if (animeCard) { e.preventDefault(); this.navigateTo("details", animeCard.dataset.id); }

const favoriteBtn = e.target.closest('.favorite-btn');
if(favoriteBtn) { e.preventDefault(); e.stopPropagation(); this.toggleFavorite(favoriteBtn.dataset.animeId); }
});

DOM.modalOverlay.addEventListener("click", e => { if (e.target === DOM.modalOverlay) this.closeModal(); });
document.addEventListener("keydown", e => { if (e.key === "Escape" && DOM.modalOverlay.classList.contains("active")) this.closeModal(); });
window.addEventListener("beforeunload", () => this.saveUserData());
},

loadUserData() {
try {
const data = localStorage.getItem("animeUserData");
if (data) {
const parsed = JSON.parse(data);
if (parsed.user && parsed.user.nickname) {
this.state.user = parsed.user;
if (!this.state.user.avatar) this.state.user.avatar = '';
if (!this.state.user.bio) this.state.user.bio = '';
if (this.state.user.showFavorites === undefined) this.state.user.showFavorites = true;
if (this.state.user.showHistory === undefined) this.state.user.showHistory = true;
this.state.favorites = new Set(parsed.favorites || []);
this.state.watchHistory = parsed.watchHistory || [];
this.state.shikiData = parsed.shikiData || {};
} else {
this.state.user = null;
}
}
} catch (e) { console.warn("Failed to load user data", e); }
this.updateProfileButton();
},

saveUserData() {
try {
const data = {
user: this.state.user,
favorites: Array.from(this.state.favorites),
watchHistory: this.state.watchHistory,
shikiData: this.state.shikiData
};
localStorage.setItem("animeUserData", JSON.stringify(data));
} catch (e) { console.warn("Failed to save user data", e); }
},

updateProfileButton() {
if (this.state.user && this.state.user.nickname) {
const userAvatar = this.state.user.avatar || '';
if (userAvatar) {
DOM.profileBtn.style.backgroundImage = `url(${userAvatar})`;
DOM.profileBtn.style.backgroundSize = 'cover';
DOM.profileBtn.style.backgroundPosition = 'center';
DOM.profileBtn.textContent = '';
} else {
DOM.profileBtn.style.backgroundImage = '';
DOM.profileBtn.textContent = this.state.user.nickname.charAt(0).toUpperCase();
}
} else {
DOM.profileBtn.style.backgroundImage = '';
DOM.profileBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>`;
}
},

addToWatchHistory(anime) {
if (!anime || !anime.id) return;
const existingIndex = this.state.watchHistory.findIndex(item => item.id === anime.id);
if (existingIndex > -1) this.state.watchHistory.splice(existingIndex, 1);
this.state.watchHistory.unshift(anime);
if (this.state.watchHistory.length > 50) this.state.watchHistory.pop();
this.saveUserData();
},

toggleFavorite(animeId) {
if (!animeId) return;
if (!this.state.user) { this.showToast("Необходимо авторизоваться", "error"); return; }
const idStr = String(animeId);
if (this.state.favorites.has(idStr)) {
this.state.favorites.delete(idStr);
this.showToast("Удалено из избранного");
} else {
this.state.favorites.add(idStr);
this.showToast("Добавлено в избранное");
}
this.saveUserData();
this.updateFavoriteButtons();
},

updateFavoriteButtons() {
document.querySelectorAll('.favorite-btn').forEach(btn => {
const animeId = String(btn.dataset.animeId);
const isFavorite = this.state.favorites.has(animeId);
btn.classList.toggle('active', isFavorite);
btn.innerHTML = `
<svg viewBox="0 0 24 24"><path d="${isFavorite ? 'M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z' : 'M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.36H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z'}"/></svg>
${isFavorite ? 'В избранном' : 'В избранное'}
`;
});
},

debounce: (func, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; },

showToast(message, type = "success") {
const toast = document.createElement("div");
toast.className = `toast ${type}`; toast.textContent = message;
document.body.appendChild(toast);
setTimeout(() => toast.classList.add("show"), 10);
setTimeout(() => { toast.classList.remove("show"); setTimeout(() => toast.remove(), 300); }, 3000);
},

handleRoute() {
const hash = window.location.hash.substring(1) || "home";
const [view, param] = hash.split("/");
this.navigateTo(view, param, false);
},

async navigateTo(view, param = '', updateHistory = true) {
if (this.state.heroInterval) { clearInterval(this.state.heroInterval); this.state.heroInterval = null; }
this.state.currentView = view;

if (updateHistory) {
const newHash = param ? `${view}/${param}` : view;
window.history.pushState({ view, param }, "", `#${newHash}`);
}

this.setActiveNav(view);
DOM.pages.forEach(p => p.classList.remove('active'));
const targetPage = document.getElementById(`${view}-page`) || document.getElementById('home-page');
targetPage.classList.add('active');
window.scrollTo({ top: 0, behavior: 'smooth' });

const viewHandlers = {
home: () => this.showHomePage(),
catalog: () => this.showCatalogPage(),
details: id => this.showDetailsPage(id),
profile: () => this.showProfilePage(),
settings: () => this.showSettingsPage(),
search: query => this.showSearchPage(query),
favorites: () => this.showFavoritesPage(),
history: () => this.showHistoryPage()
};
await (viewHandlers[view] || viewHandlers.home)(param);
},

setActiveNav(view) {
DOM.navLinks.forEach(l => l.classList.toggle('active', l.dataset.nav === view));
DOM.mobileNavItems.forEach(l => l.classList.toggle('active', l.dataset.nav === view));
},

renderLoader: () => `<div class="page-loader"><div class="loading-spinner"></div></div>`,

async fetchAnimesGraphQL(filters = {}) {
const { limit = 24, order = 'popularity', genre = '', search = '', page = 1 } = filters;

const query = `
query {
animes(
limit: ${limit}, 
order: ${order}
${genre ? `, genre: "${genre}"` : ''}
${search ? `, search: "${search}"` : ''}
${page ? `, page: ${page}` : ''}
) {
id
name
russian
score
kind
status
episodes
episodesAired
airedOn { year }
description
poster { 
originalUrl
main2xUrl
}
screenshots {
originalUrl
}
genres { 
id 
russian 
}
}
}
`;

const cacheKey = `graphql_${JSON.stringify(filters)}`;
if (this.state.cache.has(cacheKey)) {
return this.state.cache.get(cacheKey);
}

try {
await API_RATE_LIMITER.waitForSlot();

const response = await fetch(API_GRAPHQL, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ query })
});

if (!response.ok) {
if (response.status === 429) {
console.warn('Rate limit exceeded, waiting...');
await new Promise(resolve => setTimeout(resolve, 2000));
return this.fetchAnimesGraphQL(filters); 
}
throw new Error(`HTTP error! Status: ${response.status}`);
}

const result = await response.json();
const animes = result.data?.animes || [];

const formattedAnimes = animes.map(anime => ({
id: anime.id,
name: anime.name,
russian: anime.russian,
score: anime.score,
kind: anime.kind,
status: anime.status,
episodes: anime.episodes,
episodes_aired: anime.episodesAired,
aired_on: anime.airedOn?.year ? `${anime.airedOn.year}-01-01` : null,
description: anime.description,
poster2x: anime.poster?.main2xUrl || null,
posterUrl: anime.poster?.main2xUrl || anime.poster?.originalUrl,
bannerUrl: anime.screenshots?.[0]?.originalUrl || anime.poster?.originalUrl || anime.poster?.main2xUrl,
genres: anime.genres
}));

this.state.cache.set(cacheKey, formattedAnimes);
setTimeout(() => this.state.cache.delete(cacheKey), 300000);

return formattedAnimes;
} catch (error) {
console.error("GraphQL Error:", error);
this.showToast("Ошибка загрузки данных", "error");
return [];
}
},

async fetchAnimeByIdGraphQL(id) {
const query = `
query {
animes(ids: "${id}", limit: 1) {
id
name
russian
score
kind
status
episodes
episodesAired
airedOn { year }
description
descriptionHtml
poster { 
originalUrl
main2xUrl
}
genres { 
id 
russian 
}
}
}
`;

const cacheKey = `anime_${id}`;
if (this.state.cache.has(cacheKey)) {
return this.state.cache.get(cacheKey);
}

try {
await API_RATE_LIMITER.waitForSlot();

const response = await fetch(API_GRAPHQL, {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'User-Agent': 'AnimeApp/2.0' },
body: JSON.stringify({ query })
});

if (!response.ok) {
if (response.status === 429) {
console.warn('Rate limit exceeded for anime', id, ', waiting...');
await new Promise(resolve => setTimeout(resolve, 2000));
return this.fetchAnimeByIdGraphQL(id); 
}
throw new Error(`HTTP error! Status: ${response.status}`);
}

const result = await response.json();
const anime = result.data?.animes?.[0];

if (!anime) return null;

const formatted = {
id: anime.id,
name: anime.name,
russian: anime.russian,
score: anime.score,
kind: anime.kind,
status: anime.status,
episodes: anime.episodes,
episodes_aired: anime.episodesAired,
aired_on: anime.airedOn?.year ? `${anime.airedOn.year}-01-01` : null,
description: anime.description,
description_html: anime.descriptionHtml,
poster2x: anime.poster?.main2xUrl || null,
posterUrl: anime.poster?.main2xUrl || anime.poster?.originalUrl,
genres: anime.genres
};

this.state.cache.set(cacheKey, formatted);
setTimeout(() => this.state.cache.delete(cacheKey), 300000);

return formatted;
} catch (error) {
console.error("GraphQL Error:", error);
return null;
}
},

async fetchData(endpoint, options = {}) {
const cacheKey = endpoint + JSON.stringify(options);
if (this.state.cache.has(cacheKey)) {
return this.state.cache.get(cacheKey);
}
try {
const response = await fetch(`${API_BASE}/api${endpoint}`, {
...options,
headers: { ...options.headers }
});

if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

const data = await response.json();
this.state.cache.set(cacheKey, data);
setTimeout(() => this.state.cache.delete(cacheKey), 300000);
return data;
} catch (error) {
console.error("Fetch Error:", endpoint, error);
return null;
}
},

getPosterUrl(anime) {
if (!anime) return PLACEHOLDER_IMAGE;

if (anime.posterUrl) {
return anime.posterUrl.startsWith('http') ? anime.posterUrl : `${API_BASE}${anime.posterUrl}`;
}

const image = anime.image || {};
let imageUrl = image.original || image.preview || image.x96;

if (!imageUrl) return PLACEHOLDER_IMAGE;

return imageUrl.startsWith('http') ? imageUrl : `${API_BASE}${imageUrl}`;
},

getBannerUrl(anime) {
if (!anime) return PLACEHOLDER_IMAGE;

if (anime.bannerUrl) {
return anime.bannerUrl.startsWith('http') ? anime.bannerUrl : `${API_BASE}${anime.bannerUrl}`;
}

return this.getPosterUrl(anime);
},

escapeHtml: s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]),

renderAnimeCard(anime) {
if(!anime || !anime.russian) return '';

const posterUrl = this.getPosterUrl(anime);
const year = anime.aired_on ? new Date(anime.aired_on).getFullYear() : '';

return `
<a href="#details/${anime.id}" class="anime-card" data-id="${anime.id}">
<div class="anime-card-poster">
<img 
src="${posterUrl}" 
${anime.poster2x ? `srcset="${anime.poster2x} 2x"` : ''}
alt="${this.escapeHtml(anime.russian)}" 
loading="lazy"
onerror="this.src='${PLACEHOLDER_IMAGE}'"
>
<div class="anime-card-play"><svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg></div>
</div>
<h3 class="anime-card-title">${this.escapeHtml(anime.russian)}</h3>
<div class="anime-card-info">
${anime.score && anime.score > 0 ? `<span class="anime-card-info-rating"><svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/></svg> ${anime.score}</span>` : ''}
${anime.score && year ? ' • ' : ''}
${year}
</div>
</a>`;
},

renderAnimeGrid(list, container) {
if (!list || list.length === 0) {
container.innerHTML = '<div class="empty-state"><h2>Ничего не найдено</h2><p>Попробуйте изменить параметры поиска.</p></div>';
return;
}
container.innerHTML = list.map(anime => this.renderAnimeCard(anime)).join('');
},

async showHomePage() {
const homeContent = document.getElementById('home-content');
homeContent.innerHTML = this.renderLoader();

const releases = await this.fetchAnimesGraphQL({ limit: 24, order: 'popularity' });
const restOngoing = await this.fetchData(`/animes?status=ongoing&order=aired_on&limit=50`);
const now = new Date();
const cutoff = new Date(now.getTime() - 45 * 24 * 60 * 60 * 1000);
let recent = Array.isArray(restOngoing) ? restOngoing.filter(a => {
if (!a || !a.aired_on) return false;
const d = new Date(a.aired_on);
return !Number.isNaN(d.getTime()) && d >= cutoff && d <= now && a.status === 'ongoing';
}) : [];
const seenIds = new Set();
recent = recent.filter(a => { if (seenIds.has(a.id)) return false; seenIds.add(a.id); return true; });
const recentHQ = await Promise.all(recent.slice(0, 24).map(a => this.fetchAnimeByIdGraphQL(a.id)));
const newReleases = recentHQ.filter(Boolean).slice(0, 12);

if (!releases || releases.length === 0) {
homeContent.innerHTML = '<p>Не удалось загрузить популярные релизы.</p>';
return;
}

this.state.heroItems = releases.slice(0, 5);
this.state.heroIndex = 0;

this.updateHero();
this.state.heroInterval = setInterval(() => this.changeHero(1), 7000);

homeContent.innerHTML = `
<div class="row">
<div class="row-header">
<h2 class="row-title">Популярное сейчас</h2>
<a href="#catalog" data-nav="catalog" class="row-link">
Смотреть все 
<svg viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>
</a>
</div>
<div class="card-list">${releases.slice(5, 17).map(a => this.renderAnimeCard(a)).join('')}</div>
</div>
${newReleases && newReleases.length ? `
<div class="row">
<div class="row-header">
<h2 class="row-title">Новинки</h2>
</div>
<div class="card-list">${newReleases.slice(0, 12).map(a => this.renderAnimeCard(a)).join('')}</div>
</div>` : ''}
`;
},

updateHero() {
const hero = this.state.heroItems[this.state.heroIndex];
if (!hero) return;

const heroSection = document.querySelector('.hero-section');
const heroBg = heroSection.querySelector('.hero-bg');
const heroTitle = heroSection.querySelector('.hero-title');
const heroMeta = heroSection.querySelector('.hero-meta');
const heroDescription = heroSection.querySelector('.hero-description');
const heroActions = heroSection.querySelector('.hero-actions');

heroBg.classList.remove('loaded');

const banner1x = this.getBannerUrl(hero);
const banner2x = hero.poster2x || banner1x;
heroBg.style.backgroundImage = `image-set(url(${banner1x}) 1x, url(${banner2x}) 2x)`;

const year = hero.aired_on ? new Date(hero.aired_on).getFullYear() : '';

heroTitle.textContent = hero.russian;
heroMeta.innerHTML = `
${hero.kind ? `<span>${hero.kind}</span>` : ''}
${year ? `<span>${year}</span>` : ''}
${hero.score ? `<span class="anime-card-info-rating"><svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/></svg> ${hero.score}</span>` : ''}
`;
heroDescription.textContent = hero.description || 'Описание отсутствует.';
heroActions.innerHTML = `
<a href="#details/${hero.id}" class="btn btn-primary" data-id="${hero.id}">Смотреть</a>
`;

requestAnimationFrame(() => {
heroBg.classList.add('loaded');
});
},

changeHero(dir) {
const len = this.state.heroItems.length; 
if(len === 0) return;
this.state.heroIndex = (this.state.heroIndex + dir + len) % len;
this.updateHero();
},

getPlayerSources(shikiId) {
return [
{id: 0, name: 'Kodik', url: `https://kodik.info/find-player?shikimoriID=${shikiId}`},
{id: 1, name: 'Kodik Зеркало', url: `https://kodik.cc/find-player?shikimoriID=${shikiId}`}
];
},

initDualPlayers(shikiId) {
const sources = this.getPlayerSources(shikiId);
const header = document.getElementById('playerHeader');
const frame0 = document.getElementById('playerFrame0');
const frame1 = document.getElementById('playerFrame1');
if (!header || !frame0 || !frame1) return;

header.innerHTML = sources.map(s => `<button class="player-btn" data-player-id="${s.id}">${s.name}</button>`).join('');

const storageKey = `player_choice_${shikiId}`;
const saved = Number(localStorage.getItem(storageKey));
let active = Number.isFinite(saved) && saved < sources.length ? saved : 0;

const applyActive = () => {
header.querySelectorAll('.player-btn').forEach(b => b.classList.toggle('active', Number(b.dataset.playerId) === active));
frame0.style.display = active === 0 ? '' : 'none';
frame1.style.display = active === 1 ? '' : 'none';
};

applyActive();

header.addEventListener('click', (e) => {
const btn = e.target.closest('.player-btn');
if (!btn) return;
active = Number(btn.dataset.playerId);
localStorage.setItem(storageKey, String(active));
applyActive();
});

const fallbackOnce = () => {
const nextPlayer = (active + 1) % sources.length;
active = nextPlayer;
localStorage.setItem(storageKey, String(active));
applyActive();
};

const timeoutMs = 10000;
let timeoutId = setTimeout(fallbackOnce, timeoutMs);
const clearT = () => { if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; } };
frame0.addEventListener('load', clearT, { once: true });
frame1.addEventListener('load', clearT, { once: true });
frame0.addEventListener('error', fallbackOnce, { once: true });
frame1.addEventListener('error', fallbackOnce, { once: true });
},

initPlayerJS(shikiId, container) {
console.log('Инициализация PlayerJS для', shikiId);
console.log('PlayerJS доступен:', typeof Playerjs !== 'undefined');
console.log('Контейнер:', container);

container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">Загрузка PlayerJS...</div>';

const playerId = `playerjs_${shikiId}_${Date.now()}`;

if (typeof Playerjs === 'undefined') {
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">PlayerJS не загружен<br><small>Обновите страницу</small></div>';
return;
}

this.fetchPlayerJSData(shikiId).then(videoData => {
console.log('Полученные данные для PlayerJS:', videoData);
console.log('Тип file:', typeof videoData.file);
console.log('Содержимое file:', videoData.file);
console.log('Poster:', videoData.poster);

if (!videoData || !videoData.file) {
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">Нет видео данных</div>';
return;
}

container.innerHTML = '';
container.id = playerId;

const playerConfig = {
id: playerId,
file: videoData.file,
poster: videoData.poster,
width: '100%',
height: '100%',
autoplay: false,
controls: true,
lang: 'ru'
};

console.log('Конфигурация PlayerJS:');
console.log('- ID:', playerConfig.id);
console.log('- File:', playerConfig.file);
console.log('- Poster:', playerConfig.poster);
console.log('- Полная конфигурация:', playerConfig);

try {
console.log('Попытка создания PlayerJS...');
const player = new Playerjs(playerConfig);
console.log('PlayerJS создан успешно:', player);

container.style.border = '2px solid blue';
container.style.borderRadius = '8px';

setTimeout(() => {
try {
if (player && typeof player.api === 'function') {
player.api('addEventListener', 'ready', () => {
console.log('PlayerJS готов к работе');
container.style.border = '2px solid green';
});

player.api('addEventListener', 'error', (error) => {
console.error('Ошибка PlayerJS:', error);
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">Ошибка воспроизведения видео<br><small>Попробуйте другой плеер</small></div>';
});

player.api('addEventListener', 'play', () => {
console.log('PlayerJS начал воспроизведение');
});
} else {
console.error('PlayerJS API недоступен');
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">PlayerJS API недоступен</div>';
}
} catch (apiError) {
console.error('Ошибка API PlayerJS:', apiError);
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">Ошибка API PlayerJS</div>';
}
}, 2000);

} catch (error) {
console.error('Критическая ошибка инициализации PlayerJS:', error);
console.error('Тип ошибки:', error.name);
console.error('Сообщение ошибки:', error.message);
console.error('Stack trace:', error.stack);

try {
console.log('Попытка альтернативной инициализации...');
const fallbackUrl = Array.isArray(videoData.file) ? videoData.file[0].file : videoData.file;
container.innerHTML = `<iframe src="${fallbackUrl}" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>`;
console.log('Альтернативный iframe создан');
} catch (altError) {
console.error('Альтернативный способ тоже не работает:', altError);
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">PlayerJS полностью недоступен<br><small>Используйте другие плееры</small></div>';
}
}

}).catch(error => {
console.error('Ошибка получения данных для PlayerJS:', error);
container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 16px;">Ошибка загрузки видео данных</div>';
});
},

initUniversalPlayer(shikiId, container) {
console.log('Инициализация AniJadx Player для', shikiId);

container.innerHTML = `
<div id="initPlayer">
  <div id="shadow"></div>
  <div class="player-iframe padding-5">
    <center>
      <b style="margin: 0;font-size: 12px;color: #dc1ef1;">
        Не работает видео? Переключитесь на другой плеер!
      </b>
    </center>
    
    <!-- Кнопки переключения плееров -->
    <div style="text-align: center; margin: 10px 0; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
      <button class="player-switch-btn active" data-src="https://kodik.info/find-player?shikimoriID=${shikiId}" 
        style="background: #4a9eff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        Kodik
      </button>
      <button class="player-switch-btn" data-src="https://kodik.cc/find-player?shikimoriID=${shikiId}"
        style="background: #3a3b45; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        Kodik CC
      </button>
      <button class="player-switch-btn" data-src="https://aniqit.com/serial/${shikiId}/player/720p"
        style="background: #3a3b45; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        AniQit
      </button>
      <button class="player-switch-btn" data-src="https://animego.org/anime/${shikiId}"
        style="background: #3a3b45; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        AnimeGO
      </button>
    </div>
    
    <div class="embed-responsive embed-responsive-16by9">
      <iframe id="mainPlayerFrame" 
        src="https://kodik.info/find-player?shikimoriID=${shikiId}" 
        class="embed-responsive-item" 
        frameborder="0" 
        allowfullscreen 
        allow="autoplay *; fullscreen *">
      </iframe>
    </div>
  </div>
</div>
`;

const switchButtons = container.querySelectorAll('.player-switch-btn');
const mainFrame = container.querySelector('#mainPlayerFrame');

switchButtons.forEach(btn => {
btn.addEventListener('click', () => {
switchButtons.forEach(b => {
b.classList.remove('active');
b.style.background = '#3a3b45';
});

btn.classList.add('active');
btn.style.background = '#4a9eff';

const newSrc = btn.getAttribute('data-src');
mainFrame.src = newSrc;

console.log('Переключение на плеер:', btn.textContent, newSrc);
});

btn.addEventListener('mouseenter', () => {
if (!btn.classList.contains('active')) {
btn.style.background = '#5a6b7d';
}
});

btn.addEventListener('mouseleave', () => {
if (!btn.classList.contains('active')) {
btn.style.background = '#3a3b45';
}
});
});

console.log('AniJadx Player инициализирован успешно');
},

async fetchPlayerJSData(shikiId) {
try {
const animeInfo = await this.fetchAnimeByIdGraphQL(shikiId);
if (!animeInfo) return null;

const videoSources = await this.searchMultipleVideoSources(shikiId, animeInfo);

if (videoSources && videoSources.length > 0) {
if (videoSources.length > 1) {
return {
file: videoSources,
poster: animeInfo.posterUrl
};
} else {
return {
file: videoSources[0].file,
poster: animeInfo.posterUrl
};
}
} else {
return {
file: [
{
title: `${animeInfo.russian || animeInfo.name} - Kodik`,
file: `https://kodik.info/find-player?shikimoriID=${shikiId}`,
poster: animeInfo.posterUrl
},
{
title: `${animeInfo.russian || animeInfo.name} - Kodik CC`, 
file: `https://kodik.cc/find-player?shikimoriID=${shikiId}`,
poster: animeInfo.posterUrl
}
],
poster: animeInfo.posterUrl
};
}
} catch (error) {
console.error('Ошибка получения данных для PlayerJS:', error);
return null;
}
},

async searchMultipleVideoSources(shikiId, animeInfo) {
try {
const sources = [];

const searchPromises = [
this.searchKodikSources(shikiId, animeInfo),
this.searchAnimevostSources(shikiId, animeInfo),
this.searchJutsuSources(shikiId, animeInfo),
this.searchAnimegaSources(shikiId, animeInfo)
];

const results = await Promise.allSettled(searchPromises);

results.forEach((result, index) => {
if (result.status === 'fulfilled' && result.value) {
sources.push(...result.value);
}
});

return sources;
} catch (error) {
console.error('Ошибка поиска видео источников:', error);
return [];
}
},

async searchKodikSources(shikiId, animeInfo) {
try {
return [
{
title: `${animeInfo.russian || animeInfo.name} - Kodik`,
file: `https://kodik.info/find-player?shikimoriID=${shikiId}`,
poster: animeInfo.posterUrl
},
{
title: `${animeInfo.russian || animeInfo.name} - Kodik CC`,
file: `https://kodik.cc/find-player?shikimoriID=${shikiId}`,
poster: animeInfo.posterUrl
}
];
} catch (error) {
console.log('Kodik недоступен:', error);
return [];
}
},

async searchAnimevostSources(shikiId, animeInfo) {
try {
const animeName = animeInfo.russian || animeInfo.name;
return [
{
title: `${animeName} - Animevost`,
file: `https://animevost.org/tip/search/id/${shikiId}`,
poster: animeInfo.posterUrl
},
{
title: `${animeName} - Animevost Alt`,
file: `https://v2.animevost.org/tip/search/id/${shikiId}`,
poster: animeInfo.posterUrl
}
];
} catch (error) {
console.log('Animevost недоступен:', error);
return [];
}
},

async searchJutsuSources(shikiId, animeInfo) {
try {
const animeName = animeInfo.russian || animeInfo.name;
const searchQuery = encodeURIComponent(animeName);
return [
{
title: `${animeName} - Jutsu`,
file: `https://jut.su/search/?q=${searchQuery}`,
poster: animeInfo.posterUrl
},
{
title: `${animeName} - Jutsu Online`,
file: `https://jutsu.online/search/?q=${searchQuery}`,
poster: animeInfo.posterUrl
}
];
} catch (error) {
console.log('Jutsu недоступен:', error);
return [];
}
},

async searchAnimegaSources(shikiId, animeInfo) {
try {
const animeName = animeInfo.russian || animeInfo.name;
return [
{
title: `${animeName} - Animego`,
file: `https://animego.org/search/all?q=${encodeURIComponent(animeName)}`,
poster: animeInfo.posterUrl
},
{
title: `${animeName} - 9anime`,
file: `https://9anime.to/search?keyword=${encodeURIComponent(animeName)}`,
poster: animeInfo.posterUrl
}
];
} catch (error) {
console.log('Animega недоступен:', error);
return [];
}
},

debugPlayers(shikiId) {
console.log('=== ОТЛАДКА ПЛЕЕРОВ ===');
console.log('ShikimoriID:', shikiId);
console.log('PlayerJS доступен:', typeof Playerjs !== 'undefined');
console.log('Источники плееров:', this.getPlayerSources(shikiId));

this.fetchPlayerJSData(shikiId).then(data => {
console.log('Данные для PlayerJS:', data);
}).catch(error => {
console.error('Ошибка получения данных:', error);
});
},

async showDetailsPage(id) {
const page = document.getElementById('details-page'); 
page.innerHTML = this.renderLoader();

const anime = await this.fetchAnimeByIdGraphQL(id);

if (!anime) { 
page.innerHTML = '<div class="empty-state"><h2>Аниме не найдено</h2></div>'; 
return; 
}

this.addToWatchHistory(anime);

const [franchiseData, actualSimilarData, fallbackData] = await Promise.all([
this.fetchData(`/animes/${id}/franchise`),
this.fetchData(`/animes/${id}/similar`),
this.fetchAnimesGraphQL({ limit: 8, order: 'popularity' })
]);

const franchiseReleases = franchiseData?.nodes
?.filter(n => n?.node?.id && n.node.russian)
.map(n => ({
...n.node,
posterUrl: this.getPosterUrl(n.node)
})) || [];

  const similarBase = (actualSimilarData || [])
    .filter(a => a && a.id)
    .slice(0, 16);

  let similarReleases = [];
  try {
    const gqlSimilar = await Promise.all(similarBase.map(a => this.fetchAnimeByIdGraphQL(a.id)));
    similarReleases = gqlSimilar
      .filter(Boolean)
      .filter(a => String(a.id) !== String(id))
      .map(a => ({
        ...a,
        posterUrl: this.getPosterUrl(a)
      }))
      .slice(0, 8);
  } catch (e) {
    console.warn('GQL similar fetch failed, using REST images', e);
  }

  if (similarReleases.length === 0) {
    similarReleases = similarBase.map(a => ({
      ...a,
      posterUrl: a.image?.original || this.getPosterUrl(a)
    }));
  }

  if (similarReleases.length < 8 && Array.isArray(anime.genres) && anime.genres.length) {
    try {
      const genreId = String(anime.genres[0]?.id || '');
      if (genreId) {
        const byGenre = await this.fetchAnimesGraphQL({ limit: 16, order: 'popularity', genre: genreId });
        const toAdd = byGenre
          .filter(a => a?.id && String(a.id) !== String(id) && !similarReleases.find(s => String(s.id) === String(a.id)))
          .slice(0, 8 - similarReleases.length)
          .map(a => ({ ...a, posterUrl: this.getPosterUrl(a) }));
        if (toAdd.length) similarReleases.push(...toAdd);
      }
    } catch (e) {}
  }

  if (similarReleases.length === 0 && fallbackData) {
    similarReleases = fallbackData
      .filter(a => a?.id && a.russian && a.id != id)
      .slice(0, 8)
      .map(a => ({
        ...a,
        posterUrl: this.getPosterUrl(a)
      }));
  }

const posterUrl = this.getPosterUrl(anime);
const poster2x = anime.poster2x || posterUrl;

page.innerHTML = `
<div class="details-grid">
<div class="details-sidebar">
  <div class="details-poster">
  <img src="${posterUrl}" srcset="${poster2x} 2x" alt="${this.escapeHtml(anime.russian)}" onerror="this.src='${PLACEHOLDER_IMAGE}'">
  </div>
<div class="details-meta">
<div class="details-meta-row">
<span class="details-meta-label">Тип:</span><span class="details-meta-value">${anime.kind || 'н/д'}</span>
</div>
<div class="details-meta-row">
<span class="details-meta-label">Год:</span><span class="details-meta-value">${anime.aired_on ? new Date(anime.aired_on).getFullYear() : 'н/д'}</span>
</div>
<div class="details-meta-row">
<span class="details-meta-label">Статус:</span><span class="details-meta-value">${anime.status || 'н/д'}</span>
</div>
<div class="details-meta-row">
<span class="details-meta-label">Эпизоды:</span><span class="details-meta-value">${anime.episodes_aired || '?'}/${anime.episodes || '?'}</span>
</div>
${anime.score ? `
<div class="details-meta-row">
<span class="details-meta-label">Рейтинг:</span><span class="details-meta-value">⭐ ${anime.score}</span>
</div>
` : ''}
</div>
<div class="details-actions">
<button class="btn btn-secondary favorite-btn" data-anime-id="${anime.id}"></button>
</div>
</div>
<div class="details-main-content">
<h1>${this.escapeHtml(anime.russian)}</h1>
${anime.name ? `<h2>${this.escapeHtml(anime.name)}</h2>` : ''}

<div class="player-container" id="playerContainer">
  <div class="player-header" id="playerHeader"></div>
  <div class="player-frame">
    <iframe id="playerFrame0" src="about:blank" allowfullscreen loading="lazy"></iframe>
    <iframe id="playerFrame1" src="about:blank" allowfullscreen loading="lazy" style="display:none"></iframe>
  </div>
  <div class="player-note">Если плеер не работает — переключитесь на другой.</div>
</div>

<div class="tabs">
<button class="tab-item active" data-tab="description-tab">Описание</button>
${similarReleases.length ? '<button class="tab-item" data-tab="similar-tab">Похожие</button>' : ''}
${franchiseReleases.length ? '<button class="tab-item" data-tab="franchise-tab">Франшиза</button>' : ''}
</div>
<div id="description-tab" class="tab-content active">
<div class="details-description">
${anime.description_html || '<p>Описание отсутствует.</p>'}
</div>
</div>
${similarReleases.length ? `
<div id="similar-tab" class="tab-content">
<div class="card-list"></div>
</div>
` : ''}
${franchiseReleases.length ? `
<div id="franchise-tab" class="tab-content">
<div class="card-list"></div>
</div>
` : ''}
</div>
</div>
`;

if (similarReleases.length) {
this.renderAnimeGrid(similarReleases, page.querySelector('#similar-tab .card-list'));
}
if (franchiseReleases.length) {
this.renderAnimeGrid(franchiseReleases, page.querySelector('#franchise-tab .card-list'));
}

document.querySelectorAll('.tab-item').forEach(tab => {
tab.addEventListener('click', () => {
document.querySelector('.tab-item.active')?.classList.remove('active'); 
tab.classList.add('active');
document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
document.getElementById(tab.dataset.tab)?.classList.add('active');
});
});

this.updateFavoriteButtons();

this.debugPlayers(id);

this.initDualPlayers(id);
},

async showCatalogPage() {
const page = document.getElementById('catalog-page');
page.innerHTML = `
<div class="catalog-header">
<h1>Каталог аниме</h1>
<p>Откройте для себя тысячи аниме на любой вкус.</p>
</div>
<div class="filters" id="catalogFilters"></div>
<div class="catalog-grid" id="catalogGrid">${this.renderLoader()}</div>
<div class="catalog-pagination" id="catalogPagination"></div>
`;
await this.setupFilters();
await this.loadCatalogContent();
},

async setupFilters() {
const container = document.getElementById('catalogFilters');
let genres = await this.fetchData("/genres");

if (genres) {
const seen = new Set();
genres = genres.filter(genre => {
const isAnime = genre.kind === 'anime';
const isDuplicate = seen.has(genre.name);
if(isAnime && !isDuplicate) {
seen.add(genre.name);
return true;
}
return false;
});
} else {
genres = [];
}

  const categoryItems = [
    { value: 'all', label: 'Все' },
    { value: 'new', label: 'Новинки' }
  ];
  const sortItems = [
    { value: 'popularity', label: 'По популярности' },
    { value: 'ranked', label: 'По рейтингу' },
    { value: 'name', label: 'По алфавиту' }
  ];

const genreItems = [{ value: '', label: 'Все' }, ...genres.map(g => ({ value: String(g.id), label: this.escapeHtml(g.russian) }))];

  container.innerHTML = `
  <div class="custom-select" id="categorySelect">
    <button class="custom-select-trigger" type="button">
      <span class="label">${categoryItems.find(i => i.value === (this.state.selectedCategory || 'all'))?.label}</span>
      <svg viewBox="0 0 24 24"><path d="M7,10L12,15L17,10H7Z"/></svg>
    </button>
    <div class="custom-options"></div>
  </div>
  <div class="custom-select" id="genreSelect">
    <button class="custom-select-trigger" type="button">
      <span class="label">${genreItems.find(i => i.value === String(this.state.selectedGenre || ''))?.label || 'Все'}</span>
      <svg viewBox="0 0 24 24"><path d="M7,10L12,15L17,10H7Z"/></svg>
    </button>
    <div class="custom-options"></div>
  </div>
  <div class="custom-select" id="orderSelect">
    <button class="custom-select-trigger" type="button">
      <span class="label">${sortItems.find(i => i.value === (this.state.selectedOrder || 'popularity'))?.label}</span>
      <svg viewBox="0 0 24 24"><path d="M7,10L12,15L17,10H7Z"/></svg>
    </button>
    <div class="custom-options"></div>
  </div>
  `;

const buildOptions = (wrap, items, current) => {
  wrap.innerHTML = items.map(i => `<div class="custom-option ${i.value===current?'active':''}" data-value="${i.value}">${i.label}</div>`).join('');
};

  const categoryEl = document.getElementById('categorySelect');
  const genreEl = document.getElementById('genreSelect');
  const sortEl = document.getElementById('orderSelect');
  buildOptions(categoryEl.querySelector('.custom-options'), categoryItems, this.state.selectedCategory||'all');
  buildOptions(genreEl.querySelector('.custom-options'), genreItems, String(this.state.selectedGenre||''));
  buildOptions(sortEl.querySelector('.custom-options'), sortItems, this.state.selectedOrder||'popularity');

  const closeAll = (except) => {
    [categoryEl, genreEl, sortEl].forEach(el => { if (el !== except) el.classList.remove('open'); });
  };
document.addEventListener('click', (e) => {
  if (!container.contains(e.target)) closeAll();
});

const attachSelect = (root, items, onSelect) => {
  const trigger = root.querySelector('.custom-select-trigger');
  const options = root.querySelector('.custom-options');
  trigger.addEventListener('click', (e) => { e.stopPropagation(); const isOpen = root.classList.contains('open'); closeAll(); root.classList.toggle('open', !isOpen); });
  options.addEventListener('click', (e) => {
    const opt = e.target.closest('.custom-option');
    if (!opt) return;
    const val = opt.dataset.value;
    onSelect(val, opt.textContent.trim());
    options.querySelectorAll('.custom-option').forEach(o => o.classList.toggle('active', o === opt));
    root.classList.remove('open');
  });
};

  attachSelect(categoryEl, categoryItems, (val, label) => { this.state.selectedCategory = val; this.state.catalogPage = 1; categoryEl.querySelector('.label').textContent = label; this.loadCatalogContent(); });
  attachSelect(genreEl, genreItems, (val, label) => { this.state.selectedGenre = val; this.state.catalogPage = 1; genreEl.querySelector('.label').textContent = label; this.loadCatalogContent(); });
  attachSelect(sortEl, sortItems, (val, label) => { this.state.selectedOrder = val; this.state.catalogPage = 1; sortEl.querySelector('.label').textContent = label; this.loadCatalogContent(); });

const genreOptionsWrap = genreEl.querySelector('.custom-options');
const searchWrap = document.createElement('div');
searchWrap.className = 'custom-search';
searchWrap.innerHTML = '<input type="text" placeholder="Поиск жанра...">';
genreOptionsWrap.prepend(searchWrap);
const genreSearchInput = searchWrap.querySelector('input');
genreSearchInput.addEventListener('input', () => {
  const term = genreSearchInput.value.trim().toLowerCase();
  genreOptionsWrap.querySelectorAll('.custom-option').forEach(opt => {
    const text = opt.textContent.trim().toLowerCase();
    opt.style.display = term === '' || text.includes(term) ? '' : 'none';
  });
});
}
,

  async loadCatalogContent() {
  const grid = document.getElementById('catalogGrid'); 
  grid.innerHTML = this.renderLoader();
  
  const genre = this.state.selectedGenre || '';
  const order = this.state.selectedOrder || 'popularity';
  const page = this.state.catalogPage || 1;
  const limit = 36;
  let data = [];
  let hasNext = false;

  if (this.state.selectedCategory === 'new') {
    const now = new Date();
    const cutoff = new Date(now.getTime() - 45 * 24 * 60 * 60 * 1000);
    const restPage = await this.fetchData(`/animes?status=ongoing&order=aired_on&limit=50&page=${page}`) || [];
    const filtered = restPage.filter(a => a && a.aired_on && new Date(a.aired_on) >= cutoff && new Date(a.aired_on) <= now);
    const seen = new Set();
    const unique = filtered.filter(a => { if (seen.has(a.id)) return false; seen.add(a.id); return true; });
    const hq = await Promise.all(unique.slice(0, limit + 8).map(a => this.fetchAnimeByIdGraphQL(a.id)));
    data = hq.filter(Boolean).slice(0, limit);
    hasNext = data.length === limit;
  } else {
    data = await this.fetchAnimesGraphQL({ limit, order, genre, page });
    hasNext = Array.isArray(data) && data.length === limit;
  }

  this.renderAnimeGrid(data, grid);
  this.renderCatalogPagination(hasNext);
  },

  renderCatalogPagination(hasNext) {
    const wrap = document.getElementById('catalogPagination');
    if (!wrap) return;
    const page = this.state.catalogPage || 1;
    wrap.innerHTML = `
      <button class="page-btn" id="prevPage" ${page <= 1 ? 'disabled' : ''}>Назад</button>
      <span class="page-indicator">Стр. ${page}</span>
      <button class="page-btn" id="nextPage" ${hasNext ? '' : 'disabled'}>Вперед</button>
    `;
    wrap.querySelector('#prevPage')?.addEventListener('click', () => { if (this.state.catalogPage > 1) { this.state.catalogPage -= 1; this.loadCatalogContent(); window.scrollTo({ top: 0, behavior: 'smooth' }); } });
    wrap.querySelector('#nextPage')?.addEventListener('click', () => { if (hasNext) { this.state.catalogPage += 1; this.loadCatalogContent(); window.scrollTo({ top: 0, behavior: 'smooth' }); } });
  },

async showProfilePage() {
if (!this.state.user || !this.state.user.nickname) { 
this.openAuthModal(); 
return; 
}

if (!this.state.shikiData.id) {
const whoami = await this.fetchData('/users/whoami');
if(whoami) {
this.state.shikiData = {
id: whoami.id,
favorites: whoami.stats.full_statuses.anime.find(s => s.name === 'planned')?.size || 0,
watched: whoami.stats.full_statuses.anime.find(s => s.name === 'completed')?.size || 0
};
this.saveUserData();
}
}

const page = document.getElementById('profile-page');
const userInitial = this.state.user.nickname.charAt(0).toUpperCase();
const userAvatar = this.state.user.avatar || '';
const userBio = this.state.user.bio || '';

page.innerHTML = `
<div id="profile-page-grid">
<div class="profile-sidebar">
<div class="profile-avatar" style="${userAvatar ? `background-image: url(${userAvatar})` : ''}">${userAvatar ? '' : userInitial}</div>
<h1>${this.escapeHtml(this.state.user.nickname)}</h1>
<p>${this.escapeHtml(this.state.user.email)}</p>
${userBio ? `<p style="color: var(--text-secondary); font-size: 13px; margin-top: 8px; line-height: 1.5;">${this.escapeHtml(userBio)}</p>` : ''}
<div class="profile-stats">
<div class="profile-stat">
<div class="profile-stat-value">${this.state.shikiData.favorites || 0}</div>
<div class="profile-stat-label">В избранном</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value">${this.state.shikiData.watched || 0}</div>
<div class="profile-stat-label">Просмотрено</div>
</div>
</div>
<button class="btn btn-secondary" id="settingsBtn" style="width: 100%; margin-bottom: 12px;">
<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
<path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
</svg>
<span>Настройки</span>
</button>
<button class="btn btn-secondary" id="logoutBtn" style="width: 100%;">Выйти</button>
</div>
<div class="profile-main-content">
<div class="profile-section">
<h2>Избранное <a href="#favorites" data-nav="favorites">Смотреть все</a></h2>
<div class="card-list" id="profile-favorites">${this.state.favorites.size > 0 ? this.renderLoader() : '<p style="color: var(--text-secondary);">Список избранного пуст.</p>'}</div>
</div>
<div class="profile-section">
<h2>История просмотра <a href="#history" data-nav="history">Смотреть все</a></h2>
<div class="card-list" id="profile-history">${this.state.watchHistory.length > 0 ? '' : '<p style="color: var(--text-secondary);">История пуста.</p>'}</div>
</div>
</div>
</div>
`;

const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
logoutBtn.addEventListener('click', () => this.logout());
}

const settingsBtn = document.getElementById('settingsBtn');
if (settingsBtn) {
settingsBtn.addEventListener('click', () => this.navigateTo('settings'));
}

if (this.state.watchHistory.length > 0) {
this.renderAnimeGrid(this.state.watchHistory.slice(0, 4), document.getElementById('profile-history'));
}

if(this.state.favorites.size > 0) {
const favIds = Array.from(this.state.favorites).slice(0, 4);
const favs = await Promise.all(favIds.map(id => this.fetchAnimeByIdGraphQL(id)));
this.renderAnimeGrid(favs.filter(Boolean), document.getElementById('profile-favorites'));
}
},

async showSearchPage(query) {
const page = document.getElementById('search-page');
page.innerHTML = `
<div class="search-header">
<h1>Результаты по запросу: <span>"${this.escapeHtml(query)}"</span></h1>
</div>
<div class="catalog-grid" id="searchGrid">${this.renderLoader()}</div>
`;

const data = await this.fetchAnimesGraphQL({ search: query, limit: 50 });
this.renderAnimeGrid(data, document.getElementById('searchGrid'));
},

async showFavoritesPage() {
const page = document.getElementById('favorites-page');
page.innerHTML = `
<div class="catalog-header">
<h1>Избранное</h1>
<p>Ваши любимые аниме</p>
</div>
<div class="catalog-grid" id="favoritesGrid"></div>
`;

const grid = document.getElementById('favoritesGrid');

if (!this.state.user) { 
grid.innerHTML = '<div class="empty-state"><h2>Нужна авторизация</h2><p>Войдите в аккаунт, чтобы видеть избранное.</p></div>'; 
return; 
}

if (this.state.favorites.size === 0) { 
grid.innerHTML = '<div class="empty-state"><h2>Здесь пока пусто</h2><p>Добавляйте аниме в избранное.</p></div>'; 
return; 
}

grid.innerHTML = this.renderLoader();
const favoriteAnimes = await Promise.all(
Array.from(this.state.favorites).map(id => this.fetchAnimeByIdGraphQL(id))
);
this.renderAnimeGrid(favoriteAnimes.filter(Boolean), grid);
},

async showHistoryPage() {
const page = document.getElementById('history-page');
page.innerHTML = `
<div class="catalog-header">
<h1>История просмотров</h1>
<p>Аниме, которые вы смотрели</p>
</div>
<div class="catalog-grid" id="historyGrid"></div>
`;

const grid = document.getElementById('historyGrid');

if (!this.state.user) { 
grid.innerHTML = '<div class="empty-state"><h2>Нужна авторизация</h2><p>Войдите в аккаунт, чтобы видеть историю.</p></div>'; 
return; 
}

if (this.state.watchHistory.length === 0) { 
grid.innerHTML = '<div class="empty-state"><h2>Здесь пока пусто</h2><p>Начните просмотр аниме.</p></div>'; 
return; 
}

this.renderAnimeGrid(this.state.watchHistory, grid);
},

handleSearch() {
const query = DOM.searchInput.value.trim();
if (query.length > 1) {
this.navigateTo("search", query);
} else if (this.state.currentView === 'search') {
this.navigateTo("home");
}
},

openAuthModal() {
DOM.modalOverlay.innerHTML = `
<div class="modal-content">
<button class="modal-close-btn" id="modalCloseBtn">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
<line x1="18" y1="6" x2="6" y2="18"/>
<line x1="6" y1="6" x2="18" y2="18"/>
</svg>
</button>
<h2 style="margin-bottom:1.5rem;text-align:center;">Вход в аккаунт</h2>
<form id="loginForm">
<div class="form-group">
<label for="login">Логин</label>
<input type="text" id="login" class="form-input" value="Tester" required>
</div>
<div class="form-group">
<label for="loginPassword">Пароль</label>
<input type="password" id="loginPassword" class="form-input" value="password" required>
</div>
<button type="submit" class="submit-btn">Войти</button>
</form>
</div>
`;

document.getElementById('modalCloseBtn').addEventListener('click', () => this.closeModal());
document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));

DOM.modalOverlay.classList.add("active");
},

showSettingsPage() {
if (!this.state.user) { 
this.openAuthModal(); 
return; 
}

const page = document.getElementById('settings-page');
const userInitial = this.state.user.nickname.charAt(0).toUpperCase();
const userAvatar = this.state.user.avatar || '';
const userBio = this.state.user.bio || '';
const showFavorites = this.state.user.showFavorites !== false;
const showHistory = this.state.user.showHistory !== false;

page.innerHTML = `
<button class="back-btn" id="backToProfile">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M19 12H5M12 19l-7-7 7-7"/>
</svg>
<span>Назад в профиль</span>
</button>

<div class="settings-page-content">
<h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Настройки аккаунта</h1>
<p style="color: var(--text-secondary); margin-bottom: 32px;">Управление профилем и приватностью</p>

<form id="settingsForm">
<div class="settings-section">
<h3>Профиль</h3>
<div class="avatar-upload-wrapper">
<div class="avatar-preview" id="avatarPreview" style="${userAvatar ? `background-image: url(${userAvatar})` : ''}">${userAvatar ? '' : userInitial}</div>
<div class="avatar-upload-controls">
<div class="file-input-wrapper">
<input type="file" id="avatarInput" accept="image/*">
<label for="avatarInput" class="file-input-label">
<svg viewBox="0 0 24 24" fill="currentColor">
<path d="M21,19V5c0-1.1-0.9-2-2-2H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14C20.1,21,21,20.1,21,19z M8.5,13.5l2.5,3.01L14.5,12 l4.5,6H5L8.5,13.5z"/>
</svg>
<span>Выбрать фото</span>
</label>
</div>
<p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Рекомендуется: квадратное изображение, до 2 МБ</p>
</div>
</div>

<div class="form-group">
<label for="bioInput">Описание профиля</label>
<textarea id="bioInput" placeholder="Расскажите о себе...">${this.escapeHtml(userBio)}</textarea>
</div>
</div>

<div class="settings-section">
<h3>Приватность</h3>
<div class="privacy-toggle">
<div class="privacy-toggle-label">
<strong>Показывать избранное</strong>
<span>Другие пользователи смогут видеть ваше избранное</span>
</div>
<label class="toggle-switch">
<input type="checkbox" id="showFavoritesToggle" ${showFavorites ? 'checked' : ''}>
<span class="toggle-slider"></span>
</label>
</div>
<div class="privacy-toggle">
<div class="privacy-toggle-label">
<strong>Показывать историю</strong>
<span>Другие пользователи смогут видеть вашу историю просмотров</span>
</div>
<label class="toggle-switch">
<input type="checkbox" id="showHistoryToggle" ${showHistory ? 'checked' : ''}>
<span class="toggle-slider"></span>
</label>
</div>
</div>

<button type="submit" class="submit-btn">Сохранить изменения</button>
</form>
</div>
`;

document.getElementById('backToProfile').addEventListener('click', () => this.navigateTo('profile'));
document.getElementById('settingsForm').addEventListener('submit', (e) => this.handleSettingsSave(e));
document.getElementById('avatarInput').addEventListener('change', (e) => this.handleAvatarChange(e));
},

closeModal() { 
DOM.modalOverlay.classList.remove("active"); 
setTimeout(() => DOM.modalOverlay.innerHTML = "", 300); 
},

logout() {
this.state.user = null; 
this.state.favorites.clear(); 
this.state.watchHistory = [];
this.state.shikiData = {};
localStorage.removeItem("animeUserData");
this.updateProfileButton();
this.navigateTo('home'); 
this.showToast("Вы вышли из аккаунта");
},

handleLogin(e) {
e.preventDefault();

const nickname = document.getElementById('login').value.trim();
const password = document.getElementById('loginPassword').value.trim();

if (nickname && password) {
this.state.user = { 
nickname: nickname, 
email: `${nickname.toLowerCase()}@example.com`,
avatar: '',
bio: '',
showFavorites: true,
showHistory: true
};
this.state.shikiData = {
favorites: 3,
watched: 40
};
this.updateProfileButton();
this.saveUserData();
this.showToast("Вход выполнен успешно!");
this.closeModal();

setTimeout(() => {
this.navigateTo('profile');
}, 300);
} else {
this.showToast("Заполните все поля", "error");
}
},

handleAvatarChange(e) {
const file = e.target.files[0];
if (!file) return;

if (file.size > 2 * 1024 * 1024) {
this.showToast("Файл слишком большой. Максимум 2 МБ", "error");
return;
}

if (!file.type.startsWith('image/')) {
this.showToast("Пожалуйста, выберите изображение", "error");
return;
}

const reader = new FileReader();
reader.onload = (event) => {
const avatarPreview = document.getElementById('avatarPreview');
if (avatarPreview) {
avatarPreview.style.backgroundImage = `url(${event.target.result})`;
avatarPreview.textContent = '';
avatarPreview.dataset.newAvatar = event.target.result;
}
};
reader.readAsDataURL(file);
},

handleSettingsSave(e) {
e.preventDefault();

const avatarPreview = document.getElementById('avatarPreview');
const newAvatar = avatarPreview?.dataset.newAvatar || this.state.user.avatar || '';
const bio = document.getElementById('bioInput').value.trim();
const showFavorites = document.getElementById('showFavoritesToggle').checked;
const showHistory = document.getElementById('showHistoryToggle').checked;

this.state.user.avatar = newAvatar;
this.state.user.bio = bio;
this.state.user.showFavorites = showFavorites;
this.state.user.showHistory = showHistory;

this.saveUserData();

this.updateProfileButton();

this.showToast("Настройки успешно сохранены!");

setTimeout(() => {
this.navigateTo('profile');
}, 500);
},
};

window.app = app;
document.addEventListener("DOMContentLoaded", () => app.init());
</script>
</body>
</html>
